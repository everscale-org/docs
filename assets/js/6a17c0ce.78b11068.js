"use strict";(self.webpackChunkeverscale_docs_website=self.webpackChunkeverscale_docs_website||[]).push([[9330],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,o=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=c(n),m=s,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||o;return n?a.createElement(h,r(r({ref:t},d),{},{components:n})):a.createElement(h,r({ref:t},d))}));function h(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var o=n.length,r=new Array(o);r[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:s,r[1]=i;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4079:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=n(7462),s=(n(7294),n(3905));const o={sidebar_position:4,description:"Integrate EVER into your backend"},r="Add EVER to your backend",i={unversionedId:"develop/recipes/backend-integration",id:"develop/recipes/backend-integration",title:"Add EVER to your backend",description:"Integrate EVER into your backend",source:"@site/../../src/develop/recipes/backend-integration.md",sourceDirName:"develop/recipes",slug:"/develop/recipes/backend-integration",permalink:"/develop/recipes/backend-integration",draft:!1,editUrl:"https://github.com/everscale-org/docs/edit/main/.build/website/../../src/develop/recipes/backend-integration.md",tags:[],version:"current",lastUpdatedAt:1688555554,formattedLastUpdatedAt:"Jul 5, 2023",sidebarPosition:4,frontMatter:{sidebar_position:4,description:"Integrate EVER into your backend"},sidebar:"tutorialSidebar",previous:{title:"Advanced usage of Surf Keeper",permalink:"/develop/recipes/surf-wallet-advanced"},next:{title:"TIP3 Integration Guide",permalink:"/develop/recipes/tip3-integration"}},l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Setting up Blockchain Access",id:"setting-up-blockchain-access",level:2},{value:"Using Evercloud",id:"using-evercloud",level:3},{value:"Using DApp Server",id:"using-dapp-server",level:3},{value:"1. System Requirements",id:"1-system-requirements",level:4},{value:"2.1 Prerequisites",id:"21-prerequisites",level:4},{value:"2.2 Configuration",id:"22-configuration",level:4},{value:"2.3 Deployment",id:"23-deployment",level:4},{value:"Setting up Wallet Account",id:"setting-up-wallet-account",level:2},{value:"Using CLI tool",id:"using-cli-tool",level:3},{value:"1. Install Everdev",id:"1-install-everdev",level:4},{value:"2. Configure network connection",id:"2-configure-network-connection",level:4},{value:"3. Set a giver contract on your network",id:"3-set-a-giver-contract-on-your-network",level:4},{value:"4. Get wallet account contract files",id:"4-get-wallet-account-contract-files",level:4},{value:"5. Create wallet account signer",id:"5-create-wallet-account-signer",level:4},{value:"6. Deploy the wallet account contract to blockchain",id:"6-deploy-the-wallet-account-contract-to-blockchain",level:4},{value:"Using SDK",id:"using-sdk",level:3},{value:"Multisig Wallet",id:"multisig-wallet",level:4},{value:"Ever Wallet",id:"ever-wallet",level:4},{value:"Monitoring  transactions",id:"monitoring--transactions",level:2},{value:"Pagination",id:"pagination",level:3},{value:"Subscription",id:"subscription",level:3},{value:"Withdrawing from wallet accounts",id:"withdrawing-from-wallet-accounts",level:2},{value:"Using CLI tool",id:"using-cli-tool-1",level:3},{value:"(Optional) Multi-owner accounts and Confirm transaction",id:"optional-multi-owner-accounts-and-confirm-transaction",level:4},{value:"Mitigating risks of token loss due to user error",id:"mitigating-risks-of-token-loss-due-to-user-error",level:4},{value:"Using SDK",id:"using-sdk-1",level:3},{value:"Multisig Wallet",id:"multisig-wallet-1",level:4},{value:"Ever Wallet",id:"ever-wallet-1",level:4},{value:"Mitigating risks of token loss due to user error",id:"mitigating-risks-of-token-loss-due-to-user-error-1",level:4}],d={toc:c},u="wrapper";function p(e){let{components:t,...n}=e;return(0,s.kt)(u,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"add-ever-to-your-backend"},"Add EVER to your backend"),(0,s.kt)("h2",{id:"introduction"},"Introduction"),(0,s.kt)("p",null,"This document describes the various ways to accomplish the most important tasks of running a backend application that supports EVER."),(0,s.kt)("p",null,"There are a few different ways to accomplish the necessary tasks:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Blockchain access may be set up either through the ",(0,s.kt)("a",{parentName:"li",href:"https://docs.evercloud.dev/products/evercloud/get-started"},"Evercloud")," or through your own supernode - the ",(0,s.kt)("a",{parentName:"li",href:"https://docs.evercloud.dev/products/dapp-server-ds"},"DApp server"),"."),(0,s.kt)("li",{parentName:"ul"},"User account management can be accomplished either through the ",(0,s.kt)("a",{parentName:"li",href:"https://docs.everos.dev/everdev/"},"everdev")," command line tool or integrate into your backend with  Ever SDK client libraries. Both of these approaches are compatible with either of the blockchain access setups.")),(0,s.kt)("h2",{id:"setting-up-blockchain-access"},"Setting up Blockchain Access"),(0,s.kt)("h3",{id:"using-evercloud"},"Using Evercloud"),(0,s.kt)("p",null,"Using ",(0,s.kt)("a",{parentName:"p",href:"https://docs.evercloud.dev/products/evercloud/get-started"},"Evercloud")," allows you to work with TVM blockchains without having to run your own node. Everdev and SDK can connect to it, as if it were a regular node. It has the same API as a node, and provides all needed capabilities."),(0,s.kt)("p",null,"This page lists the ",(0,s.kt)("a",{parentName:"p",href:"https://docs.evercloud.dev/products/evercloud/networks-endpoints"},"cloud endpoints"),". To get access credentials go through this ",(0,s.kt)("a",{parentName:"p",href:"https://docs.evercloud.dev/products/evercloud/get-started"},"guide"),"."),(0,s.kt)("p",null,"Whenever you have to specify a network endpoint in the examples given below, use the endpoints and credentials you receive in the ",(0,s.kt)("a",{parentName:"p",href:"https://dashboard.evercloud.dev/projects"},"Evercloud dashboard"),"."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("strong",{parentName:"p"},"Note"),": We recommend testing out the full setup on the developer network first.")),(0,s.kt)("h3",{id:"using-dapp-server"},"Using DApp Server"),(0,s.kt)("p",null,"If you prefer to run your own node, you may set up your own ",(0,s.kt)("a",{parentName:"p",href:"https://docs.evercloud.dev/products/dapp-server-ds"},"DApp server"),". It is a client supernode, that may be set up on your own servers and provide full access to TVM networks. To connect to it with Everdev or SDK, it needs to have a domain name and a DNS record. You can specify its URL whenever you have to set the network in the examples given below."),(0,s.kt)("p",null,"Get the setup scripts in this repository: ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/evernode-ds"},"https://github.com/tonlabs/evernode-ds")),(0,s.kt)("h4",{id:"1-system-requirements"},"1. System Requirements"),(0,s.kt)("table",null,(0,s.kt)("thead",{parentName:"table"},(0,s.kt)("tr",{parentName:"thead"},(0,s.kt)("th",{parentName:"tr",align:null},"Configuration"),(0,s.kt)("th",{parentName:"tr",align:null},"CPU (cores)"),(0,s.kt)("th",{parentName:"tr",align:null},"RAM (GiB)"),(0,s.kt)("th",{parentName:"tr",align:null},"Storage (GiB)"),(0,s.kt)("th",{parentName:"tr",align:null},"Network (Gbit/s)"))),(0,s.kt)("tbody",{parentName:"table"},(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"Recommended"),(0,s.kt)("td",{parentName:"tr",align:null},"24"),(0,s.kt)("td",{parentName:"tr",align:null},"128"),(0,s.kt)("td",{parentName:"tr",align:null},"2000"),(0,s.kt)("td",{parentName:"tr",align:null},"1")))),(0,s.kt)("p",null,"NVMe SSD disks are recommended for storage."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"For simplicity, all services are deployed on one host and the system requirements for it are high, so it makes sense to distribute services across different servers.\nAfter understanding this installation process, you can easily customize it for yourself."),(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("a",{parentName:"p",href:"https://github.com/itgoldio/everscale-dapp-server"},"itgoldio/everscale-dapp-server"),": Consider this project if you prefer deployment via Ansible.")),(0,s.kt)("h4",{id:"21-prerequisites"},"2.1 Prerequisites"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Host OS: Linux (all scripts tested on Ubuntu 20.04)."),(0,s.kt)("li",{parentName:"ul"},"DApp server is accessed via HTTPS, so your server must have a fully qualified domain name.\\\nA self-signed certificate will be received on start-up and will be renewed automatically."),(0,s.kt)("li",{parentName:"ul"},"Installed Git, Docker Engine, Docker CLI, Docker Compose v2 or later.")),(0,s.kt)("h4",{id:"22-configuration"},"2.2 Configuration"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2.2.1 Set variables")),(0,s.kt)("p",null,"Check ",(0,s.kt)("inlineCode",{parentName:"p"},"configure.sh")," and set at least these environment variables:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"NETWORK_TYPE"),(0,s.kt)("li",{parentName:"ul"},"EVERNODE_FQDN"),(0,s.kt)("li",{parentName:"ul"},"LETSENCRYPT_EMAIL")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2.2.2 Generate credentials to access the ArangoDB web interface")),(0,s.kt)("p",null,"Generate credentials (usernames and password) for basic authentication and update ",(0,s.kt)("inlineCode",{parentName:"p"},".htpasswd")," file.\nYou can generate it by running ",(0,s.kt)("inlineCode",{parentName:"p"},"htpasswd -nb <name> <password>")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"2.2.3 Run configuration script")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ ./configure.sh\n")),(0,s.kt)("p",null,"This script creates ",(0,s.kt)("inlineCode",{parentName:"p"},"./deploy")," directory"),(0,s.kt)("h4",{id:"23-deployment"},"2.3 Deployment"),(0,s.kt)("p",null,"Run ",(0,s.kt)("inlineCode",{parentName:"p"},"./up.sh"),"."),(0,s.kt)("p",null,"After the script completes normally (it takes 30 min approx.), the node starts synchronizing its state, which can take several hours.\\\nUse the following command to check the progress:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"    docker exec rnode /ton-node/tools/console -C /ton-node/configs/console.json --cmd getstats\n")),(0,s.kt)("p",null,"Script output example:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'tonlabs console 0.1.286\nCOMMIT_ID: 5efe6bb8f2a974ba0e6b1ea3e58233632236e182\nBUILD_DATE: 2022-10-17 02:32:44 +0300\nCOMMIT_DATE: 2022-08-12 00:22:07 +0300\nGIT_BRANCH: master\n{\n    "sync_status":  "synchronization_finished",\n    "masterchainblocktime": 1665988670,\n    "masterchainblocknumber":   9194424,\n    "node_version": "0.51.1",\n    "public_overlay_key_id":    "S4TaVdGitzTApe7GFCj8DbuRIkVEbg+ODzBxhQGIUG0=",\n    "timediff": 6,\n    "shards_timediff":  6,\n     ----%<---------------------\n}\n')),(0,s.kt)("p",null,"If the ",(0,s.kt)("inlineCode",{parentName:"p"},"timediff")," parameter is less than 10 seconds, synchronization with masterchain is complete.\\\n",(0,s.kt)("inlineCode",{parentName:"p"},'"sync_status": "synchronization finished"')," means synchronization with workchains is complete"),(0,s.kt)("h2",{id:"setting-up-wallet-account"},"Setting up Wallet Account"),(0,s.kt)("p",null,"Currently we can recommend the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/EverSurf/multisig2"},"SetcodeMultisig")," contract for use in user accounts. It is well tested and secure, supports multiple custodians, and can be set up to require several independent signatures for any transfers."),(0,s.kt)("p",null,"Alternatively, you may use the Ever Wallet contract. It has some different features and capabilities. You can read about them and find the contract files in this ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/broxus/ever-wallet-contract"},"repository"),"."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Note"),": Ever Wallet however is not currently supported by Everdev CLI tool, so only the SDK approach will work for it. If you choose it, you only need to examine the SDK sections with Ever Wallet samples. "),(0,s.kt)("h3",{id:"using-cli-tool"},"Using CLI tool"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/everdev/"},"Everdev"),", the command line tool for development on the Everscale blockchain, allows to write scripts to deploy any smart contracts to the blockchain, call all contract methods, sign transactions, and generally manage an account."),(0,s.kt)("p",null,"It works with both Evercloud and DApp server."),(0,s.kt)("h4",{id:"1-install-everdev"},"1. Install Everdev"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"$ npm install -g everdev\n")),(0,s.kt)("p",null,"It requires ",(0,s.kt)("a",{parentName:"p",href:"https://docs.npmjs.com/downloading-and-installing-node-js-and-npm"},"NPM")," to be installed."),(0,s.kt)("p",null,"If you experience any problems with installation, check out our ",(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/everdev/troubleshooting"},"troubleshooting")," section."),(0,s.kt)("h4",{id:"2-configure-network-connection"},"2. Configure network connection"),(0,s.kt)("p",null,"Everdev has a built-in ",(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/everdev/command-line-interface/network-tool"},"network")," tool to manage your networks and access credentials."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Using Evercloud endpoints")),(0,s.kt)("p",null,"Add your Evercloud endpoint to everdev and make it default:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"everdev network add networkName <your-evercloud-endpoint>\neverdev network default networkName\n")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Using DApp Server endpoint")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"If you are setting up a connection via your own DApp server, user the following command to add it to the network list (it will be named ",(0,s.kt)("inlineCode",{parentName:"li"},"dappserver"),").")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev network add dappserver <your_dapp_server_endpoint>\n")),(0,s.kt)("p",null,"To set your ",(0,s.kt)("inlineCode",{parentName:"p"},"dappserver")," network as default, use the following command:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"everdev network default dappserver\n")),(0,s.kt)("h4",{id:"3-set-a-giver-contract-on-your-network"},"3. Set a giver contract on your network"),(0,s.kt)("p",null,"On Everscale, you need to sponsor a contract address in advance to be able to deploy the contract."),(0,s.kt)("p",null,"Everdev provides a way to set an account of your choice as a giver for deployment operations, so you will not have to do a separate step of sending tokens to a new contract address every time you deploy something. This contract can some multisig wallet, for example your ",(0,s.kt)("a",{parentName:"p",href:"https://ever.surf/"},"Surf")," account."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Note"),": To work automatically, the giver contract should have only one custodian."),(0,s.kt)("p",null,"To set it up, first save the custodian keys of your giver account into a signer that will be used to sign giver transactions (Learn more about the signer tool ",(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/everdev/command-line-interface/signer-tool"},"here"),"):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"everdev signer add giver_sign signer_secret_key_or_seed_phrase_in_quotes\n")),(0,s.kt)("p",null,"Then add the giver address specifying the signer to be used with it."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"everdev network giver network_name giver_address --signer giver_sign --type giver_type\n")),(0,s.kt)("p",null,"Where"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"giver_type")," is the type of the giver contract you selected (GiverV1 | GiverV2 | GiverV3 | SafeMultisigWallet | MsigV2| SetcodeMultisigWallet)"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"We recommend using ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/EverSurf/multisig2"},"Multisig 2.0 "),"as giver, for that use ",(0,s.kt)("inlineCode",{parentName:"p"},"MsigV2")," giver_type.")),(0,s.kt)("h4",{id:"4-get-wallet-account-contract-files"},"4. Get wallet account contract files"),(0,s.kt)("p",null,"We recommend using",(0,s.kt)("a",{parentName:"p",href:"https://github.com/EverSurf/multisig2"}," Multisig 2.0")," contracts as a wallet. They can be found ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/EverSurf/multisig2"},"here"),". In this guide SetcodeMultisig specifically is used."),(0,s.kt)("p",null,"Download the contract files and place them in the working folder. Direct links to its files are as follows:"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},".tvc")," - Compiled contract code"),(0,s.kt)("p",null,"SetcodeMultisig.tvc direct link:"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/EverSurf/multisig2/raw/main/build/SetcodeMultisig.tvc"},"https://github.com/EverSurf/multisig2/raw/main/build/SetcodeMultisig.tvc")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},".abi.json")," - application binary interface, describing the functions of the contract"),(0,s.kt)("p",null,"SetcodeMultisig.abi.json direct link:"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/EverSurf/multisig2/main/build/SetcodeMultisig.abi.json"},"https://raw.githubusercontent.com/EverSurf/multisig2/main/build/SetcodeMultisig.abi.json")),(0,s.kt)("p",null,"Execute the commands of the following steps from the directory with the contract files."),(0,s.kt)("h4",{id:"5-create-wallet-account-signer"},"5. Create wallet account signer"),(0,s.kt)("p",null,"To generate your wallet account signer enter the following command:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev signer generate wallet_signer\n")),(0,s.kt)("p",null,"Or, if you already have a seed phrase, add it like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'everdev signer add "your-seed-phrase-here"\n')),(0,s.kt)("p",null,"To deploy multisig wallet account you will need to specify the public key of the signer. To view it, use the following command:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"everdev signer info wallet_signer\n")),(0,s.kt)("p",null,"The keys will be displayed in terminal (if you imported the seed phrase, it will be displayed here as well):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'{\n    "name": "wallet_signer",\n    "description": "",\n    "keys": {\n        "public": "8f8779e7c1944b133a423df96d06ae770c996f19d63438dbf2f569a29529b248",\n        "secret": "ce57d2666d0d2c737a03ca4e6cfa38c5ca088dbcef43eb0353896feca8aea2a5"\n    }\n}\n\n')),(0,s.kt)("p",null,"Usually a single owner (with a single signer) per wallet account is optimal for any tasks that require automation. However, it is possible to set up accounts with multiple owners. In this case, each of the owners has to generate their own signer and provide their public keys to the deployer. Also, the signer used to deploy the account doesn't have to be among its owners."),(0,s.kt)("h4",{id:"6-deploy-the-wallet-account-contract-to-blockchain"},"6. Deploy the wallet account contract to blockchain"),(0,s.kt)("p",null,"Use the following command for a simple one-owner account:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev contract deploy SetcodeMultisig.abi.json constructor --signer wallet_signer --input owners:[<owner_public_key>],reqConfirms:1,lifetime:3600 --value 1000000000\n")),(0,s.kt)("p",null,"Where"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"value")," parameter is the amount of nanotokens to be spent on deployment (can be omitted, in which case 10 tokens from giver will be spent)"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"owner_public_key")," is usually the public key of ",(0,s.kt)("inlineCode",{parentName:"p"},"wallet_signer")," in the form ",(0,s.kt)("inlineCode",{parentName:"p"},"0x..."),"."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"lifetime")," - time in seconds that a transaction in multi-owner accounts will persits and be available for signing by other owners. For a simple multi owner account may be set to any value, as it will be executed immediately anyway."),(0,s.kt)("p",null,"Example:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"everdev contract deploy SetcodeMultisig.abi.json constructor --signer wallet_signer --input owners:[0x8f8779e7c1944b133a423df96d06ae770c996f19d63438dbf2f569a29529b248],reqConfirms:1,lifetime:3600 --value 1000000000\n")),(0,s.kt)("p",null,"For more complex cases (multiple owners etc.) view Everdev contract tool ",(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/everdev/command-line-interface/contract-management"},"docs"),"."),(0,s.kt)("p",null,"Once the contract is deployed, its address will be displayed in terminal."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'everdev contract deploy SetcodeMultisig.abi.json constructor --signer wallet_signer --input owners:[0x3da1909b7a4bd11fd9a1d79ca9713a9a8645880e0a7a12f9691c68e95d56fe75],reqConfirms:1,lifetime:3600 --value 10000000000\n\nConfiguration\n\n  Network: dev (devnet.evercloud.dev)\n  Signer:  wallet_signer (public 8f8779e7c1944b133a423df96d06ae770c996f19d63438dbf2f569a29529b248)\n\nAddress:   0:95c35b94e98c1b5c7716a9129ed5bb0798c8c336465fd8d1eb0d385e3d969494 (calculated from TVC and signer public)\n\nParameters of constructor:\n\n  owners (uint256[]): ["0x3da1909b7a4bd11fd9a1d79ca9713a9a8645880e0a7a12f9691c68e95d56fe75"]\n  reqConfirms (uint8): "1"\n  lifetime (uint32): "3600"\n\nDeploying...\nContract is deployed at address: 0:95c35b94e98c1b5c7716a9129ed5bb0798c8c336465fd8d1eb0d385e3d969494\n\n')),(0,s.kt)("h3",{id:"using-sdk"},"Using SDK"),(0,s.kt)("p",null,"You may integrate above described process of wallet account deployment into your backend code. The functionality is supported in SDK."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/ever-sdk/#community-bindings"},"Bindings")," for a large number of languages have been developed for SDK.")),(0,s.kt)("p",null,"Note, that similar to the Everdev approach described above, you have to sponsor a user account before deploying contract code. The sample assumes you use the devnet faucet of ",(0,s.kt)("a",{parentName:"p",href:"https://dashboard.evercloud.dev/"},"Evercloud Dashboard"),", where you can request test tokens to the contract address generated by the samples. In a production environment you may set up a giver to sponsor your contract deployment operations. An example of such a set up can be found in this ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/hello-wallet"},"sample"),"."),(0,s.kt)("h4",{id:"multisig-wallet"},"Multisig Wallet"),(0,s.kt)("p",null,"A sample is available in ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/msig-wallet"},"this repository")," and an overview is given below."),(0,s.kt)("p",null,"The recommended ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/blob/master/demo/msig-wallet/contract/SetcodeMultisig.sol"},"SetcodeMultisig")," contract is used."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"    // 1. ------------------ Deploy multisig wallet --------------------------------\n    // \n    // Generate a key pair for the wallet to be deployed\n    const keypair = await client.crypto.generate_random_sign_keys();\n\n    // TODO: Save generated keypair!\n    console.log('Generated wallet keys:', JSON.stringify(keypair))\n    console.log('Do not forget to save the keys!')\n\n\n    const msigABI: string =\n        readFileSync(path.resolve(__dirname, \"../contract/SetcodeMultisig.abi.json\")).toString(\"utf8\")\n\n        const msigCode: string =\n        readFileSync(path.resolve(__dirname, \"../contract/SetcodeMultisig.code.boc\")).toString(\"base64\")\n\n    // We need to know the future address of the wallet account,\n    // because its balance must be positive for the contract to be deployed\n    //\n    // Future address can be calculated from code and data of the contract\n    //\n    // For solidity contracts of version up to ***\n    // initial data consists of pubkey + all static contract variables\n    // and can be packed like this:\n\n    const initData = (await client.abi.encode_boc({\n        params: [\n            { name: \"data\", type: \"map(uint64,uint256)\" }\n        ],\n        data: {\n            \"data\": {\n                0: `0x`+keypair.public\n            //  1: 1st-static-variable-value\n            //  2: 2nd-static-variable-value\n            },\n        }\n    })).boc;\n\n    console.log('Init data', initData);\n\n    // Lets construct the initial state of the contract\n    const stateInit = (await client.boc.encode_state_init({\n        code:msigCode,\n        data:initData\n    })).state_init;\n\n    // Address is the TVM hash of the initial state + workchain id (we work in 0 workchain)\n    const msigAddress = `0:`+(await client.boc.get_boc_hash({boc: stateInit})).hash;\n    console.log('Address: ', msigAddress);\n\n\n    console.log(`You can topup your wallet from dashboard at https://dashboard.evercloud.dev`)\n    console.log(`Please send >= ${MINIMAL_BALANCE} tokens to ${msigAddress}`)\n    console.log(`awaiting...`)\n\n    // Blocking here, waiting for account balance changes.\n    // It is assumed that at this time you go to dashboard.evercloud.dev\n    // and replenish this account.\n    let balance: number\n    let accType: number\n    for (; ;) {\n        // The idiomatic way to send a request is to specify \n        // query and variables as separate properties.\n        const getInfoQuery = `\n                query getBalance($address: String!) {\n                    blockchain {\n                    account(address: $address) {\n                            info {\n                            balance\n                            acc_type\n                        }\n                    }\n                }\n            }\n            `\n        const resultOfQuery: ResultOfQuery = await client.net.query({\n            query: getInfoQuery,\n            variables: { address: msigAddress }\n        });\n        const accountInfo = resultOfQuery.result.data.blockchain.account.info;\n\n\n        const nanotokens = parseInt(accountInfo.balance, 16)\n        accType = accountInfo.acc_type;\n        if (nanotokens >= MINIMAL_BALANCE * 1e9) {\n            balance = nanotokens / 1e9\n            break\n        }\n        // TODO: rate limiting\n        await sleep(1000)\n    }\n    console.log(`Account balance is: ${balance.toString(10)} tokens. Account type is ${accType}`)\n\n    console.log(`Deploying wallet contract to address: ${msigAddress} and waiting for transaction...`)\n\n    // Encode the body with constructor call\n    let body = (await client.abi.encode_message_body({\n        address: msigAddress,\n        abi: { type: 'Json', value: msigABI },\n        call_set: {       \n            function_name: 'constructor',\n            input: {\n                owners: [`0x${keypair.public}`],\n                reqConfirms: 1,\n                lifetime: 3600 \n            }\n        },\n        is_internal:false,\n        signer:{type: 'Keys', keys: keypair}\n    })).body;\n\n    let deployMsg =  await client.boc.encode_external_in_message({\n        dst: msigAddress,\n        init: stateInit,\n        body: body\n    });\n\n    let sendRequestResult = await client.processing.send_message({\n        message: deployMsg.message,\n        send_events: false\n    });\n\n    let transaction = (await client.processing.wait_for_transaction({\n        abi: { type: 'Json', value: msigABI },\n        message: deployMsg.message,\n        shard_block_id: sendRequestResult.shard_block_id,\n        send_events: false\n    })).transaction;\n\n    console.log('Contract deployed. Transaction hash', transaction?.id)\n    assert.equal(transaction?.status, 3)\n    assert.equal(transaction?.status_name, \"finalized\")\n")),(0,s.kt)("h4",{id:"ever-wallet"},"Ever Wallet"),(0,s.kt)("p",null,"A sample is available in ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/ever-wallet"},"this repository")," and an overview is given below."),(0,s.kt)("p",null,"The ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/broxus/ever-wallet-contract"},"Ever Wallet")," contract is used."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"\n    // 1. ------------------ Deploy ever-wallet --------------------------------\n    // \n    // Generate a key pair for the wallet to be deployed\n    const keypair = await client.crypto.generate_random_sign_keys();\n\n    // TODO: Save generated keypair!\n    console.log('Generated wallet keys:', JSON.stringify(keypair))\n    console.log('Do not forget to save the keys!')\n\n    // To deploy a wallet we need its code and ABI files\n    const everWalletCode: string =\n        readFileSync(path.resolve(__dirname, \"../contract/Wallet.code.boc\")).toString(\"base64\")\n    const everWalletABI: string =\n        readFileSync(path.resolve(__dirname, \"../contract/everWallet.abi.json\")).toString(\"utf8\")\n\n        const initData = (await client.abi.encode_boc({\n            params: [\n                { name: \"publicKey\", type: \"uint256\" },\n                { name: \"timestamp\", type: \"uint64\" }\n            ],\n            data: {\n                \"publicKey\": `0x`+keypair.public,\n                \"timestamp\": 0\n            }\n        })).boc;\n\n        console.log('Init data', initData);\n    \n\n    const stateInit = (await client.boc.encode_state_init({\n        code:everWalletCode,\n        data:initData\n    })).state_init;\n\n    const everWalletAddress = `0:`+(await client.boc.get_boc_hash({boc: stateInit})).hash;\n    console.log('Address: ', everWalletAddress);\n\n\n\n    console.log(`You can topup your wallet from dashboard at https://dashboard.evercloud.dev`)\n    console.log(`Please send >= ${MINIMAL_BALANCE} tokens to ${everWalletAddress}`)\n    console.log(`awaiting...`)\n\n    // Blocking here, waiting for account balance changes.\n    // It is assumed that at this time you go to dashboard.evercloud.dev\n    // and replenish this account.\n    let balance: number\n    for (; ;) {\n        // The idiomatic way to send a request is to specify \n        // query and variables as separate properties.\n        const getBalanceQuery = `\n                query getBalance($address: String!) {\n                    blockchain {\n                    account(address: $address) {\n                            info {\n                            balance\n                        }\n                    }\n                }\n            }\n            `\n        const resultOfQuery: ResultOfQuery = await client.net.query({\n            query: getBalanceQuery,\n            variables: { address: everWalletAddress }\n        })\n\n        const nanotokens = parseInt(resultOfQuery.result.data.blockchain.account.info?.balance, 16)\n        if (nanotokens >= MINIMAL_BALANCE * 1e9) {\n            balance = nanotokens / 1e9\n            break\n        }\n        // TODO: rate limiting\n        await sleep(1000)\n    }\n    console.log(`Account balance is: ${balance.toString(10)} tokens`)\n\n\n\n    console.log(`Making first transfer+deploy from ever-wallet contract to address: -1:7777777777777777777777777777777777777777777777777777777777777777 and waiting for transaction...`)\n// Here we construct body by ABI\n// and then add state init to the message for deploy\n  \n    let body = (await client.abi.encode_message_body({\n        address: everWalletAddress,\n        abi: { type: 'Json', value: everWalletABI },\n        call_set: {      \n            function_name: 'sendTransaction',\n            input: {\n                dest: '-1:7777777777777777777777777777777777777777777777777777777777777777',\n                value: '1000000000', // amount in nano EVER\n                bounce: false,\n                flags: 3,\n                payload: ''\n            }\n        },\n        is_internal:false,\n        signer:{type: 'Keys', keys: keypair}\n    })).body;\n\n    let deployAndTransferMsg =  await client.boc.encode_external_in_message({\n        dst: everWalletAddress,\n        init: stateInit,\n        body: body\n    });\n\n    let sendRequestResult = await client.processing.send_message({\n        message: deployAndTransferMsg.message,\n        send_events: false\n    });\n\n    let transaction = (await client.processing.wait_for_transaction({\n        abi: { type: 'Json', value: everWalletABI },\n        message: deployAndTransferMsg.message,\n        shard_block_id: sendRequestResult.shard_block_id,\n        send_events: false\n    })).transaction;\n\n\n    console.log('Contract deployed. Transaction hash', transaction.id)\n    assert.equal(transaction.status, 3)\n    assert.equal(transaction.status_name, \"finalized\")\n    \n")),(0,s.kt)("h2",{id:"monitoring--transactions"},"Monitoring  transactions"),(0,s.kt)("p",null,"Lets assume we need to reliably know when customers receive or transfer funds from their wallets. Samples of transaction ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/paginate-transactions"},"pagination")," and ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/subscribe-transactions"},"subscription")," are available in the samples repository. An overview of the relevant parts is given below."),(0,s.kt)("p",null,"In these samples JS SDK is used. ",(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/ever-sdk/#community-bindings"},"Bindings")," for a large number of languages have been developed for SDK."),(0,s.kt)("h3",{id:"pagination"},"Pagination"),(0,s.kt)("p",null,"The ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/paginate-transactions"},"pagination")," sample queries and displays transactions in workchain 0 (workchain where simple transfers happen, -1 workchain is masterchain where you can find service transactions and validator transactions) from the beginning. We can get all the transaction and filter by account addresses on the backend side."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},'   async function main(client: TonClient) {\n    // In this example, we want the query to return 2 items per page.\n    const itemsPerPage = 25\n\n    // Pagination connection pattern requires a cursor, which will be set latter\n    let cursor: string = undefined\n\n    // The idiomatic way to send a request is to specify \n    // query and variables as separate properties.\n    const transactionsQuery = `\n        query listTransactions($cursor: String, $count: Int) {\n            blockchain {\n                transactions(\n                    workchain: 0\n                    first: $count\n                    after: $cursor\n                 ) {\n                    edges {\n                        node { \n                            id\n                            balance_delta\n                            account_addr\n                            # other transaction fields\n                     }\n                    }\n                    pageInfo { hasNextPage endCursor }\n                }\n            }\n        }`\n\n    for (; ;) {\n        const queryResult: ResultOfQuery = await client.net.query({\n            query: transactionsQuery,\n            variables: {\n                count: itemsPerPage,\n                cursor\n            }\n        });\n        const transactions = queryResult.result.data.blockchain.transactions;\n\n        for (const edge of transactions.edges) {\n            console.log("Transaction id:", edge.node.id);\n        }\n        if (transactions.pageInfo.hasNextPage === false) {\n            break;\n        }\n        // To read next page we initialize the cursor:\n        cursor = transactions.pageInfo.endCursor;\n        // TODO: rate limiting\n        await sleep(1000);\n    }\n\n}\nconsole.log("Getting all transactions in workchain 0 from the beginning/")\nconsole.log("Most likely this process will never end, so press CTRL+C to interrupt it")\nmain(client)\n    .then(() => {\n        process.exit(0)\n    })\n    .catch(error => {\n        console.error(error);\n        process.exit(1);\n    })\n\n\n\n// This helper function is used for limiting request rate\nfunction sleep(ms: number) { return new Promise(r => setTimeout(r, ms)) }\n')),(0,s.kt)("h3",{id:"subscription"},"Subscription"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/subscribe-transactions"},"Subscription")," sample subscribes to new transactions of the listed accounts and lists them as they appear."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},'async function main() {\n    try {\n        const client = new TonClient({ network: { endpoints: [endpoint] } })\n\n        const queryText = `\n            subscription my($list: [String!]!){\n                transactions(\n                    filter: {account_addr: { in: $list }}\n                ) {\n                    id\n                    account_addr\n                    balance_delta\n                }\n            }`\n\n        // use `client.net.unsubscribe({ handle })` to close subscription\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        const { handle } = await client.net.subscribe(\n            {\n                subscription: queryText,\n                variables: { list: addressList }\n            },\n            responseHandler,\n        );\n        console.log("Subscribed to transactions of accounts:", JSON.stringify(addressList))\n        console.log("Press CTRL+C to interrupt it")\n\n    } catch (error) {\n        if (error.code === 504) {\n            console.error(\'Network is inaccessible.\');\n        } else {\n            console.error(error);\n        }\n        process.exit(1);\n    }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction responseHandler(params: any, responseType: number) {\n    // Tip: Always wrap the logic inside responseHandler in a try-catch block\n    // or you will be surprised by non-informative errors due to the context\n    // in which the handler is executed\n    try {\n        if (responseType === 100 /* GraphQL data received */) {\n            if (params?.result) {\n                console.log(params.result);\n            }\n\n        } else {\n            // See full list of error codes here:\n            // https://docs.everos.dev/ever-sdk/reference/types-and-methods/mod_net#neterrorcode\n            console.error(params, responseType);\n        }\n    } catch (err) {\n        console.log(err);\n    }\n}\n')),(0,s.kt)("p",null,"You may test out the demo application running this process on the developer network by cloning the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples"},"sdk-samples")," repository, creating a project in  ",(0,s.kt)("a",{parentName:"p",href:"https://dashboard.evercloud.dev"},"https://dashboard.evercloud.dev"),", exporting the API endpoint as an environment variable:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"export ENDPOINT=https://devnet.evercloud.dev/<your_project_id>/graphql\n")),(0,s.kt)("p",null,"and running the following command in the ",(0,s.kt)("inlineCode",{parentName:"p"},"/demo/subscribe-transactions")," folder:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"npm run subscribe-tr\n")),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("strong",{parentName:"p"},"Note"),": Not all transactions that are successful are valid transfers and not all transactions that are aborted actually failed. Read ",(0,s.kt)("a",{parentName:"p",href:"/arch/transactions#how-to-determine-a-successful-transaction"},"here")," how to understand which transfers are successful transfers and which are not.")),(0,s.kt)("h2",{id:"withdrawing-from-wallet-accounts"},"Withdrawing from wallet accounts"),(0,s.kt)("p",null,"The specific function that is used to withdraw the funds depends on the contract chosen for the wallet account. Examples provided below are applicable for the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/EverSurf/multisig2"},"SetcodeMultisig")," contract and (in the case of the relevant SDK section, as only SDK currently supports it) ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/broxus/ever-wallet-contract"},"Ever Wallet")," contract."),(0,s.kt)("h3",{id:"using-cli-tool-1"},"Using CLI tool"),(0,s.kt)("p",null,"Command line ",(0,s.kt)("inlineCode",{parentName:"p"},"Everdev")," tool may be used to automate withdrawals from wallet account in your scripts."),(0,s.kt)("p",null,"If the user made a mistake in the destination address, and has no control over it, these funds will be lost forever. If the account does not exist, and the user makes mistakes deploying it after the funds are transferred, they may end up being lost as well."),(0,s.kt)("p",null,"So, to perform a simple transfer from a single-owner user account to any specified account, we should make sure that it is already deployed, by setting ",(0,s.kt)("inlineCode",{parentName:"p"},"bounce")," flag to true. If the account does not exist, funds will return back."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'everdev contract run SetcodeMultisig.abi.json sendTransaction --address <wallet_account_address> --signer wallet_signer --input dest:recipient_address,value:50000000000,bounce:true,flags:3,payload:""\n')),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"<wallet_account_address>")," - address of the user account. Example: 0:7bf2b2ec80371601f854bff9ed0a1171714d922c8bfc86d39e67a7e3a41b2176"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"wallet_signer")," - name of the user account owner signer"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"recipient_address")," - raw address of the recipient smart contract. Example: 255a3ad9dfa8aa4f3481856aafc7d79f47d50205190bd56147138740e9b177f3"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"value"),": - amount of tokens to transfer in nanotokens (Example: value:10000000000 sets up a transfer of 10 tokens)."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"bounce")," - use true to transfer funds only to deployed accounts."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"flags")," - use 3 for a simple transfer."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"payload"),' - use "" for simple transfer.'),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("strong",{parentName:"p"},"Note"),": To transfer all funds from the account use ",(0,s.kt)("inlineCode",{parentName:"p"},"sendTransaction")," method with flag ",(0,s.kt)("inlineCode",{parentName:"p"},"130")," and value ",(0,s.kt)("inlineCode",{parentName:"p"},"0."))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'everdev contract run SetcodeMultisig.abi.json --address <wallet_account_address> sendTransaction --signer wallet_signer --input dest:recipient_address,value:0,bounce:true,flags:130,payload:""\n')),(0,s.kt)("p",null,"Example of regular withdrawal transaction on a single-owner multisig:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},'everdev contract run SetcodeMultisig.abi.json sendTransaction --signer wallet_signer --input dest:665a62042aff317ba3f32e36b712b0f4a9d35277dd76dc38c9762cc6421681cf,value:500000000000,bounce:false,flags:3,payload:""\n\nConfiguration\n\n  Network: dev (devnet.evercloud.dev)\n  Signer:  wallet_signer (public 3da1909b7a4bd11fd9a1d79ca9713a9a8645880e0a7a12f9691c68e95d56fe75)\n\nAddress:   0:95c35b94e98c1b5c7716a9129ed5bb0798c8c336465fd8d1eb0d385e3d969494\n\nParameters of sendTransaction:\n\n  dest (address): "665a62042aff317ba3f32e36b712b0f4a9d35277dd76dc38c9762cc6421681cf"\n  value (uint128): "500000000000"\n  bounce (bool): "false"\n  flags (uint8): "3"\n  payload (cell): ""\n\n\nRunning...\n\nExecution has finished with result:\n{\n    "transaction": {\n        "json_version": 8,\n        "id": "cbeb7f8b1aa7ac89439d9c6772b699a7c042215cef090f206ecc8b21bb230fc9",\n        "boc": "te6ccgECDwEAArcAA7d5XDW5TpjBtcdxapEp7VuweYyMM2Rl/Y0esNOF49lpSUAAAOakEwMsEkhiumuyPgwNDWXdmNBHsr9g6Y6XgsntCG/AQxbMH/mAAADmo/0T8BZCW1XwAFSAICQ36AUEAQIPDE/GHimDxEADAgBvyY9CQExRYUAAAAAAAAQAAAAAAARz+2ts0g+y9Ais9VbZ65O+4BourUTTYoPq+tvoLxFJpECQJNQAnUZPYxOIAAAAAAAAAABYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAgnI1Aq0GL7DtfZycdkRDzfxJtFk47dtGidJveUmyV1aRWS0JxA5UCIBaO/paLFUAjm0/YFLGbVz5bUyQ5fEsfxqwAgHgCwYCAd0JBwEBIAgAdeAErhrcp0xg2uO4tUiU9q3YPMZGGbIy/saPWGnC8ey0pKAAABzUgmBlhshLar5JjsFmgAAAAAAAAABAAQEgCgCzSAErhrcp0xg2uO4tUiU9q3YPMZGGbIy/saPWGnC8ey0pKQAZlpiBCr/MXuj8y42txKw9KnTUnfddtw4yXYsxkIWgc9XRqUogAAYUWGAAABzUgmBlhMhLar5AAUWIASuGtynTGDa47i1SJT2rdg8xkYZsjL+xo9YacLx7LSkoDAwB4fRRR+puAACR3O0hyRMPrwVnVPX+pw1OSY/hvAY+6jc/0ST0CDjZIS4ccsC4fPFe5CZoyAH4UOealyQ5K/a8zQXPaGQm3pL0R/ZodecqXE6moZFiA4KehL5aRxo6V1W/nUAAAGHM0x8YGQltYcTHYLNgDQFjgAzLTECFX+YvdH5lxtbiVh6VOmpO+67bhxkuxZjIQtA54AAAAAAAAAAAAAAOjUpRAAQOAAA=",\n        "status": 3,\n        "status_name": "finalized",\n        "storage": {\n            "storage_fees_collected": "0x3f",\n            "status_change": 0,\n            "status_change_name": "unchanged"\n        },\n        "compute": {\n            "success": true,\n            "msg_state_used": false,\n            "account_activated": false,\n            "gas_fees": "0xc53078",\n            "gas_used": 12923,\n            "gas_limit": 0,\n            "gas_credit": 10000,\n            "mode": 0,\n            "exit_code": 0,\n            "vm_steps": 352,\n            "vm_init_state_hash": "0000000000000000000000000000000000000000000000000000000000000000",\n            "vm_final_state_hash": "0000000000000000000000000000000000000000000000000000000000000000",\n            "compute_type": 1,\n            "compute_type_name": "vm"\n        },\n        "action": {\n            "success": true,\n            "valid": true,\n            "no_funds": false,\n            "status_change": 0,\n            "total_fwd_fees": "0x1e8480",\n            "total_action_fees": "0x145850",\n            "result_code": 0,\n            "tot_actions": 2,\n            "spec_actions": 0,\n            "skipped_actions": 0,\n            "msgs_created": 2,\n            "action_list_hash": "39fdb5b66907d97a04567aab6cf5c9df700d1756a269b141f57d6df41788a4d2",\n            "tot_msg_size_cells": 2,\n            "tot_msg_size_bits": 1178\n        },\n        "credit_first": true,\n        "aborted": false,\n        "destroyed": false,\n        "tr_type": 0,\n        "tr_type_name": "ordinary",\n        "lt": "0xe6a413032c1",\n        "prev_trans_hash": "24862ba6bb23e0c0d0d65dd98d047b2bf60e98e9782c9ed086fc04316cc1ff98",\n        "prev_trans_lt": "0xe6a3fd13f01",\n        "now": 1680192863,\n        "outmsg_cnt": 2,\n        "orig_status": 1,\n        "orig_status_name": "Active",\n        "end_status": 1,\n        "end_status_name": "Active",\n        "in_msg": "b10b0866cb7320f9abac1ba6c5a09f7a60bb87b399142aa0a7dda28b086d9a40",\n        "ext_in_msg_fee": "0x2798b8",\n        "out_msgs": [\n            "ff491002eaeaf22e85055d5b055383d8aaaa030bcb5ae34a65b27f15de8e2e34",\n            "8f2f48998b041adbae47a3e8ee7541ee918299d316e07c7dbd221501a31b15d8"\n        ],\n        "account_addr": "0:95c35b94e98c1b5c7716a9129ed5bb0798c8c336465fd8d1eb0d385e3d969494",\n        "workchain_id": 0,\n        "total_fees": "0x10121bf",\n        "balance_delta": "-0x746b5dd5ef",\n        "old_hash": "3502ad062fb0ed7d9c9c764443cdfc49b45938eddb4689d26f7949b257569159",\n        "new_hash": "2d09c40e5408805a3bfa5a2c55008e6d3f6052c66d5cf96d4c90e5f12c7f1ab0"\n    },\n    "output": {\n        "transId": "0"\n    },\n    "out_messages": [\n        null\n    ]\n}\n\n')),(0,s.kt)("p",null,"Basic checks of the address format will be performed by the Everdev utility automatically, only addresses of a valid Everscale format will be accepted."),(0,s.kt)("h4",{id:"optional-multi-owner-accounts-and-confirm-transaction"},"(Optional) Multi-owner accounts and Confirm transaction"),(0,s.kt)("p",null,"Note, that if your user account has multiple custodians, the transaction has to be confirmed by the required number of signatures to be executed. This transaction ID should be communicated to other custodians, who should use it to confirm the transaction."),(0,s.kt)("p",null,"To withdraw tokens from a multi-owner account use the following command:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'everdev contract run SetcodeMultisig.abi.json submitTransaction --address <wallet_account_address> --signer wallet_signer --input \'{ "dest": "recipient_address", "value":10000000000, "bounce": false, "allBalance": false, "payload": "", "stateInit": null }\'\n')),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"<wallet_account_address>")," - address of the user account. Example: 0:7bf2b2ec80371601f854bff9ed0a1171714d922c8bfc86d39e67a7e3a41b2176"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"wallet_signer")," - name of the user account owner signer"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"value"),": - amount of tokens to transfer in nanotokens (Example: value:10000000000 sets up a transfer of 10 tokens)."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"bounce")," - use false to transfer funds to an already deployed account"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"allBalance")," - used to transfer all funds in the wallet. Use false for a simple transfer."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"payload"),' - use "" for simple transfer.'),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"stateInit")," - use ",(0,s.kt)("inlineCode",{parentName:"p"},"null")," for a simple transfer."),(0,s.kt)("p",null,"This will generate a transaction and display its ",(0,s.kt)("inlineCode",{parentName:"p"},"transId")," that will have to be confirmed by other custodians."),(0,s.kt)("p",null,"To confirm a transaction, use the following command:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev contract run SetcodeMultisig.abi.json confirmTransaction --address <wallet_account_address> --signer wallet_signer2 --input transactionId:6954030467099431873\n")),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"<wallet_account_address>")," - address of the user account. Example: 0:7bf2b2ec80371601f854bff9ed0a1171714d922c8bfc86d39e67a7e3a41b2176"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"wallet_signer2")," - signer of another multisig custodian (not the one who initiated the transaction)."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"transactionId")," \u2013 the ID of the transaction can be acquired from the custodian who created it."),(0,s.kt)("h4",{id:"mitigating-risks-of-token-loss-due-to-user-error"},"Mitigating risks of token loss due to user error"),(0,s.kt)("p",null,"The are two main cases regarding transfers to user accounts: a user may already have an active account to which they want to withdraw funds (set bounce to true), or they may want to withdraw funds to a completely new account, that doesn't exist at the time withdraw is requested (set bounce to false)."),(0,s.kt)("p",null,"The status of the account provided by the user may be checked with the following Everdev command:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev contract info --address external_address\n")),(0,s.kt)("p",null,"Example of existing account:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev contract info --address 0:665a62042aff317ba3f32e36b712b0f4a9d35277dd76dc38c9762cc6421681cf\n\nConfiguration\n\n  Network: dev (devnet.evercloud.dev)\n  Signer:  owner_keys (public 5ff6b5ba62b52b25ef347984912937bffaf2df88605e4e56cb64b9b617a28fea)\n\nAddress:   0:665a62042aff317ba3f32e36b712b0f4a9d35277dd76dc38c9762cc6421681cf\nAccount:   Active\nBalance:   \u2248 51655 tokens (51655086754193 nano)\n")),(0,s.kt)("p",null,"Example of account that doesn't exist yet:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"everdev contract info --address 0:6238e23f6987883b3d1a86e1c39c63ae2baf7f93603d0ea5dc9b6e91ef54a1ab\n\nConfiguration\n\n  Network: dev (devnet.evercloud.dev)\n  Signer:  owner_keys (public 5ff6b5ba62b52b25ef347984912937bffaf2df88605e4e56cb64b9b617a28fea)\n\nAddress:   0:6238e23f6987883b3d1a86e1c39c63ae2baf7f93603d0ea5dc9b6e91ef54a1ab (calculated from TVC and signer public)\nCode Hash: 80d6c47c4a25543c9b397b71716f3fae1e2c5d247174c52e2c19bd896442b105 (from TVC file)\nAccount:   Doesn't exist\n\n")),(0,s.kt)("p",null,"The possible results of this command are the following:"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Doesn't exist")," - account does not exist. It needs to be sponsored, then deployed, and only then will it be active."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Uninit")," - account already has some funds on it but contract code has not been deployed yet. User needs to deploy it."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Active")," - account already exists, and its code is deployed."),(0,s.kt)("p",null,"In the first to cases, the service might first transfer a small portion of the requested amount (","~","1 EVER) and request that the user deploys their contract. Upon the user's confirmation that the account is deployed, its status may be rechecked, and if it became active, the remaining amount of requested funds may be safely transferred."),(0,s.kt)("p",null,"If the account is already active, a small portion of the requested amount may be transferred to the user, and the user may be asked what amount they received (note: a small amount of the transfer, usually less than 0.05 EVER, will be spent on fees, so it's best to ask for the whole number of tokens transferred). If the amounts match, the rest of the requested funds may be transferred as well."),(0,s.kt)("h3",{id:"using-sdk-1"},"Using SDK"),(0,s.kt)("p",null,"You may integrate withdrawals from wallet account into your backend using SDK as well. "),(0,s.kt)("p",null,"In these samples JS SDK is used. ",(0,s.kt)("a",{parentName:"p",href:"https://docs.everos.dev/ever-sdk/#community-bindings"},"Bindings")," for a large number of languages have been developed for SDK."),(0,s.kt)("h4",{id:"multisig-wallet-1"},"Multisig Wallet"),(0,s.kt)("p",null,"A sample is available in ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/msig-wallet"},"this repository")," and an overview of the relevant part is given below."),(0,s.kt)("p",null,"This example shows how to generate a withdrawal transaction from a Multisig wallet, using its ",(0,s.kt)("inlineCode",{parentName:"p"},"sendTransaction")," method. Note, that if Multisig has multiple custodians, the transaction will have to be confirmed with the ",(0,s.kt)("inlineCode",{parentName:"p"},"confirmTransaction")," method."),(0,s.kt)("p",null,"In this example tokens are withdrawn from the user account to the account specified in ",(0,s.kt)("inlineCode",{parentName:"p"},"dest"),". In a proper implementation, the account given by user should be used instead."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},'    // 2.----------------------- Transfer tokens ------------------------\n    // \n    // We send 0.5 tokens. Value is written in nanotokens\n    const amount = 0.5e9\n    const dest = "-1:7777777777777777777777777777777777777777777777777777777777777777"\n\n    console.log(\'Sending 0.5 token to\', dest)\n\n    // If you want to add a comment to your transfer, create payload with it:\n\n    const comment = (await client.abi.encode_boc({\n        params: [\n            { name: "op", type: "uint32" }, // operation\n            { name: "comment", type: "bytes" }\n        ],\n        data: {\n            "op": 0, // operation = 0 means comment\n            "comment": Buffer.from("My comment").toString("hex"),\n        }\n    })).boc;\n\n    // Encode the body with sendTransaction call and comment\n    body = (await client.abi.encode_message_body({\n        address: msigAddress,\n        abi: { type: \'Json\', value: msigABI },\n        call_set: {      \n            function_name: \'sendTransaction\',\n            input: {\n                dest: dest,\n                value: amount,\n                bounce: false,\n                flags: 64,\n                payload: comment // specify "" if no payload is provided\n            }\n        },\n        is_internal:false,\n        signer:{type: \'Keys\', keys: keypair}\n    })).body;\n\n    let msg =  await client.boc.encode_external_in_message({\n        dst: msigAddress,\n        body: body\n    });\n\n    sendRequestResult = await client.processing.send_message({\n        message: msg.message,\n        send_events: false\n    });\n\n    transaction = (await client.processing.wait_for_transaction({\n        abi: { type: \'Json\', value: msigABI },\n        message: msg.message,\n        shard_block_id: sendRequestResult.shard_block_id,\n        send_events: false\n    })).transaction;\n\n    console.log(\'Transfer completed. Transaction hash\', transaction?.id)\n    assert.equal(transaction?.status, 3)\n    assert.equal(transaction?.status_name, "finalized")\n')),(0,s.kt)("h4",{id:"ever-wallet-1"},"Ever Wallet"),(0,s.kt)("p",null,"A sample is available in ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tonlabs/sdk-samples/tree/master/demo/ever-wallet"},"this repository")," and an overview is given below."),(0,s.kt)("p",null,"In this example tokens are withdrawn from the user account to the account specified in ",(0,s.kt)("inlineCode",{parentName:"p"},"dest"),". In a proper implementation, the desired destination address should be used instead."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},'    // 3.----------------- Make simple transfer -----------------------\n    // \n\n    console.log(`Making simple transfer from ever-wallet contract to address: -1:7777777777777777777777777777777777777777777777777777777777777777 and waiting for transaction...`)\n      \n    // If you want to add a comment to your transfer, create payload with it:\n\n        const comment = (await client.abi.encode_boc({\n            params: [\n                { name: "op", type: "uint32" }, // operation\n                { name: "comment", type: "bytes" }\n            ],\n            data: {\n                "op": 0, // operation = 0 means comment\n                "comment": Buffer.from("My comment").toString("hex"),\n            }\n        })).boc;\n\n\n        // encode message body by ever-wallet ABI\n         body = (await client.abi.encode_message_body({\n            address: everWalletAddress,\n            abi: { type: \'Json\', value: everWalletABI },\n            call_set: {      \n                function_name: \'sendTransaction\',\n                input: {\n                    dest: \'-1:7777777777777777777777777777777777777777777777777777777777777777\',\n                    value: \'500000000\', // amount in units (nano)\n                    bounce: false,\n                    flags: 3,\n                    payload: comment // specify "" if no payload is provided\n                }\n            },\n            is_internal:false,\n            signer:{type: \'Keys\', keys: keypair}\n        })).body;\n    \n        let transferMsg =  await client.boc.encode_external_in_message({\n            dst: everWalletAddress,\n            body: body\n        });\n    \n        sendRequestResult = await client.processing.send_message({\n            message: transferMsg.message,\n            send_events: false\n        });\n    \n        transaction = (await client.processing.wait_for_transaction({\n            abi: { type: \'Json\', value: everWalletABI },\n            message: transferMsg.message,\n            shard_block_id: sendRequestResult.shard_block_id,\n            send_events: false\n        })).transaction;\n    \n    \n        console.log(\'Contract deployed. Transaction hash\', transaction.id)\n        assert.equal(transaction.status, 3)\n        assert.equal(transaction.status_name, "finalized")\n')),(0,s.kt)("h4",{id:"mitigating-risks-of-token-loss-due-to-user-error-1"},"Mitigating risks of token loss due to user error"),(0,s.kt)("p",null,"Similarly to the everdev approach, you can add the account status check prior to sending tokens."),(0,s.kt)("p",null,"The are two main cases regarding transfers to user accounts: a user may already have an active account to which they want to withdraw funds, or they may want to withdraw funds to a completely new account, that doesn't exist at the time withdraw is requested."),(0,s.kt)("p",null,"Here is an example of checking account status in SDK:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"    let balance: number\n    let accType: number\n    for (; ;) {\n        // The idiomatic way to send a request is to specify \n        // query and variables as separate properties.\n        const getInfoQuery = `\n                query getBalance($address: String!) {\n                    blockchain {\n                    account(address: $address) {\n                            info {\n                            balance\n                            acc_type\n                        }\n                    }\n                }\n            }\n            `\n        const resultOfQuery: ResultOfQuery = await client.net.query({\n            query: getInfoQuery,\n            variables: { address: msigAddress }\n        })\n        \n\n        const nanotokens = parseInt(resultOfQuery.result.data.blockchain.account.info?.balance, 16)\n        accType = resultOfQuery.result.data.blockchain.account.info?.acc_type;\n        if (nanotokens > MINIMAL_BALANCE * 1e9) {\n            balance = nanotokens / 1e9\n            break\n        }\n        // TODO: rate limiting\n        await sleep(1000)\n    }\n    console.log(`Account balance is: ${balance.toString(10)} tokens. Account type is ${accType}`)\n")),(0,s.kt)("p",null,"In addition to checking account status prior to transferring tokens, for Ever Surf and Ever Wallet users account verification with a PIN code may be set up."),(0,s.kt)("p",null,"In the examples above the following method of encoding a text comment into transaction payload is used."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},'    // If you want to add a comment to your transfer, create payload with it:\n\n    const comment = (await client.abi.encode_boc({\n        params: [\n            { name: "op", type: "uint32" }, // operation\n            { name: "comment", type: "bytes" }\n        ],\n        data: {\n            "op": 0, // operation = 0 means comment\n            "comment": Buffer.from("My comment").toString("hex"),\n        }\n    })).boc;\n')),(0,s.kt)("p",null,"The result should be simply passed as payload parameter when generating multisig or Ever wallet transaction."),(0,s.kt)("p",null,"A small amount of tokens can be sent with a PIN code encoded into payload. The user will be able to see this PIN code in their Ever Surf or Ever Wallet app. The rest of the requested amount may be sent to the user only once they provide the PIN code, ensuring they have full control of the account."))}p.isMDXComponent=!0}}]);