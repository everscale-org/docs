<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-arch/executor">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Transaction executor | Docs of Everscale</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.everscale.network/arch/executor/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Transaction executor | Docs of Everscale"><meta data-rh="true" name="description" content="Transaction executor functional specification"><meta data-rh="true" property="og:description" content="Transaction executor functional specification"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.everscale.network/arch/executor/"><link data-rh="true" rel="alternate" href="https://docs.everscale.network/arch/executor" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.everscale.network/arch/executor" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JMT2J0B3ZE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JMT2J0B3ZE",{anonymize_ip:!0})</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.440da354.css">
<link rel="preload" href="/assets/js/runtime~main.eded8d36.js" as="script">
<link rel="preload" href="/assets/js/main.691c08bc.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Everscale Docs" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Everscale Docs" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Everscale Docs</b></a><a class="navbar__item navbar__link" href="/overview/">Overview</a><a class="navbar__item navbar__link" href="/develop/">Build</a><a class="navbar__item navbar__link" href="/validate/">Validate</a><a class="navbar__item navbar__link" href="/standard/">Standards</a><a href="https://everscale.guide/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Crash Course<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/contribute/">Contribute</a><a href="https://blog.everscale.network/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://monitoring.ever.rs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Status<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/everscale-org/docs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Welcome to Everscale</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/overview">Overview</a><button aria-label="Toggle the collapsible sidebar category &#x27;Overview&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/develop">Build</a><button aria-label="Toggle the collapsible sidebar category &#x27;Build&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/validate">Run Validator</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/spec">Specifications</a><button aria-label="Toggle the collapsible sidebar category &#x27;Specifications&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/standard">Standards</a><button aria-label="Toggle the collapsible sidebar category &#x27;Standards&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/arch">Architecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Architecture&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/basics">Basics</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/arch/networking">Networking</a><button aria-label="Toggle the collapsible sidebar category &#x27;Networking&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/arch/consensus">Consensus</a><button aria-label="Toggle the collapsible sidebar category &#x27;Consensus&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/tlb-and-boc">TL-B and BoC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/tvm">TVM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/fee-calculation">Fee calculation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/managing-gas">Gas Calculation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/arch/executor">Transaction executor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/logic-time">Logical Time</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/accounts">Accounts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/message">Message</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/transactions">Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/security">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/workchains">Workchains</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/arch/multithreading">Multithreading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/contribute">Contribute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Contribute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/arch"><span itemprop="name">Architecture</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Transaction executor</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Transaction executor</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>Transaction Executor is a crucial part of <em>Everscale</em> blockchain node. It applies incoming messages to accounts, sealing
the end result of this operation into a block in the form of a transaction object.</p><p>The Transaction Executor algorithms determine several critical aspects of smart-contracts behavior, such as:</p><ul><li>How a balance of an account is affected after the message gets processed</li><li>What outbound messages will be generated as a result</li><li>Should the account be frozen or deleted?</li><li>What fees should be charged from the accounts balance</li></ul><p>To be able to rigorously reason about a smart-contract behavior, it is important to construct the accurate model of this
module, explain the main concepts, define its properties. In other words, make the
groundwork for you, the reader, to foster the integration of this logic into the reasoning framework of your choice.</p><p>In the current work, we made the best-effort attempt to write such specification.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="document-structure">Document Structure<a href="#document-structure" class="hash-link" aria-label="Direct link to Document Structure" title="Direct link to Document Structure">​</a></h2><p>The document consists of two logical parts, intermixed with each other:
the explanation part and the specification part.</p><p>The explanation part is done by providing extensive comments for
data structures used through-out the Transaction Executor. The data
structures are presented as Rust code snippets, taken from the
original Node code. Sometimes, we intentionally omit details that
are not relevant to the Transaction Executor, requiring much wider
context to be explained.</p><p>The specification part is presented in two flavors. When the
precision is required, we describe the behavior by providing the
pseudo-code implementing some algorithm. For more general
properties, we formulate them in a form of semi-formal statements
about the system behavior.</p><p>By comparison to the program implementation, the specification
pseudo-code <code>overapproximates</code>  the implementation by throwing away
non-relevant parts of the logic, for example: sophisticated error
handling, non-interesting parts of the state being removed,
introducing reasonable assumptions that greatly simplifies the
logic, etc.</p><p>In other words, the pseudo-code shows how the system behaves for
its significant parts, putting away everything else.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="everscale-platform-architecture">Everscale Platform Architecture<a href="#everscale-platform-architecture" class="hash-link" aria-label="Direct link to Everscale Platform Architecture" title="Direct link to Everscale Platform Architecture">​</a></h2><p>The main actors of the EverScale blockchain are smart-contracts.
Smart-contracts are programs that operate user valuable assets on their behalf. Valuable assets are usually
cryptocurrency tokens or some digital goods, like NFTs.</p><p>Smart-contract execution is triggered by a message sent from some other party. If the message was delivered from the
outside world (i.e. from the user program), it is said to be <em>external</em>. Otherwise, the message is considered <em>internal</em>
.</p><p>Smart-contracts may also generate log records called <em>events</em>. Those records are used as information signals for an
external observers. They foster communication between smart-contracts and off-chain programs.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-platform-overall-architecture-is-depicted">The platform overall architecture is depicted<a href="#the-platform-overall-architecture-is-depicted" class="hash-link" aria-label="Direct link to The platform overall architecture is depicted" title="Direct link to The platform overall architecture is depicted">​</a></h4><img loading="lazy" src="https://www.plantuml.com/plantuml/png/NOyn2iCm34Ltdq8No92C6GejTEYS4xYAY4rL6sGb54hkNjKq9Qq7cSz__j_Ig4mzd1UIWfu9hfpnXi77125EeM5QYC4BXgY4EWivvr6pm94ZcgWND0SuVLzQtaD9acUuKob-CWmvp-EEWQS3E-Ob1Uj8MZLw6K75fs8bCM_O1Wxjh-m-ScZVFnYw7Yxfh_bjhtNkOuskfNLrInB2BADRNm00" class="img_ev3q"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="platform-implementation">Platform Implementation<a href="#platform-implementation" class="hash-link" aria-label="Direct link to Platform Implementation" title="Direct link to Platform Implementation">​</a></h2><p>EverScale blockchain is a database operated by a peer-to-peer network of computing nodes. The database store users code
and data in a form of programmable units called smart-contracts. Smart-contacts may communicate with other contracts and
outside world by sending messages.</p><p>The computing node is called blockchain node in our context.</p><p>Among other things, blockchain nodes are responsible for storing the smart-contract state, delivering messages from
users and smart-contracts, executing the smart-contacts code when needed.</p><p><em>Transaction Executor</em> module is a part of the blockchain node responsible for proper execution of a smart-contract code
upon receiving a message addressed to that smart-contract. The result of this execution is an updated smart-contract
state and the transaction record that gets sealed into the block candidate.</p><p>We now go into details on the internals of this module.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-executor-module">Transaction Executor Module<a href="#transaction-executor-module" class="hash-link" aria-label="Direct link to Transaction Executor Module" title="Direct link to Transaction Executor Module">​</a></h2><p>In this section, we go into the technical details of Transaction Executor module. The source code of the module is
available <a href="https://github.com/tonlabs/ton-labs-executor/tree/a28bde3e65dd35573d34e32aa4477d60162b5338" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="remark">Remark<a href="#remark" class="hash-link" aria-label="Direct link to Remark" title="Direct link to Remark">​</a></h3><p>In our opinion, the name of this module was chosen quite unfortunate. In its current form, it feels like the object being executed is a transaction. This is not true.</p><p>Transaction is an outcome of executing a message on a smart-contract state using the Transaction Executor logic. Hence, it is the message that is being executed, not the transaction.</p><p>Nevertheless, we stick with the original name not to confuse developers too much.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="inputs-and-outputs">Inputs and Outputs<a href="#inputs-and-outputs" class="hash-link" aria-label="Direct link to Inputs and Outputs" title="Direct link to Inputs and Outputs">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="the-principal-architecture-of-the-module-is-depicted">The principal architecture of the module is depicted<a href="#the-principal-architecture-of-the-module-is-depicted" class="hash-link" aria-label="Direct link to The principal architecture of the module is depicted" title="Direct link to The principal architecture of the module is depicted">​</a></h5><img loading="lazy" src="https://www.plantuml.com/plantuml/png/ROun2W8n44Nxd698OxKNi12sI64XMkG2GmmIS6UMP0A2xDqt2Gags0sFF_zz2VBqHx0HAQ6Jm0JcvLqMZaevZ7Suqveb0IO816y5qEZ5fuGFty0suEmSPv9VUCE8I-fiAwMyh4o-nFG_gwucQxhyccNOESj7__rPyuFhFk7GQkPGXMNsD9rgfpLGZbAq0m00" class="img_ev3q"><p>We now describe each input/output entity in detail, together with the logic of the computation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multichain-architecture">Multichain Architecture<a href="#multichain-architecture" class="hash-link" aria-label="Direct link to Multichain Architecture" title="Direct link to Multichain Architecture">​</a></h3><p>Everscale has a native support for multiple blockchains running in parallel.</p><p>Each blockchain might be established by introducing a separate chain called workchain. Each workchain has a unique
integer identifier in a range <code>-127 ... 127</code>, the values <code>-1</code> and <code>0</code> are already
taken. Smart-contracts from different workchains may interact with each other by message passing.</p><p>At the moment, the system implements only two workchains — Masterchain (<code>id -1</code>) and Workchain (<code>id 0</code>).</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>Currently, the creation of new workchains is not supported.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multicurrency-payments">Multicurrency payments<a href="#multicurrency-payments" class="hash-link" aria-label="Direct link to Multicurrency payments" title="Direct link to Multicurrency payments">​</a></h3><p>The native coin of Everscale blockchain is called <em>EVER</em>. However, Everscale has an ability to work with other types of
coins. While system payments like gas and storage fees are made only in Evers, the other value transfers may contain
coins of other
currencies. This contrasts with most of other blockchains where there is only a single native cryptocurrency, and other
currencies
may be made only using artificial token smart-contracts.</p><p>Currently, this feature is not used widely.</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In this document, we limit our specification effort only for the case of a single currency — Evers. This choice
significantly simplifies the business logic of the execution handlers.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hashing-algorithm">Hashing Algorithm<a href="#hashing-algorithm" class="hash-link" aria-label="Direct link to Hashing Algorithm" title="Direct link to Hashing Algorithm">​</a></h3><p>Transaction Executor uses hashing in several places to compactly store data structures fingerprints. It is done in two
steps. First, the data structure gets converted into a tree-like form. Then, a special
hashing algorithm is applied to that tree. The basic hash function used is <code>SHA256</code> from <a href="https://docs.rs/sha2/latest/sha2/" target="_blank" rel="noopener noreferrer">Sha2 Rust
package</a>.</p><p>The exact hashing algorithm, as well as tree-like representation is not interesting for our purposes, so we do not
consider it here. For details,
check <a href="https://github.com/tonlabs/ton-labs-types/blob/af1dc71a9a2b46cb0d55a0956e44726374ba7c0c/src/cell/mod.rs#L841" target="_blank" rel="noopener noreferrer">this</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameters">Parameters<a href="#parameters" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters">​</a></h2><p>Besides, incoming  message and  account, Transaction Executor  has to  have some
external   information  regarding   the   current  blockchain   and
non-blockchain state to support the TVM capabilities.  For example,
it   has   to  know   the   current   time   to  provide   it   for
smart-contracts. It  has to  have some random  seed to  support the
random number generator  facility. All of this is  passed using the
ExecuteParams structure.</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">ExecuteParams</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> state_libs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">HashmapE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> block_unixtime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> block_lt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> last_tr_lt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Arc</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">AtomicU64</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> seed_block</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> debug</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="executeparams-fields">ExecuteParams fields<a href="#executeparams-fields" class="hash-link" aria-label="Direct link to ExecuteParams fields" title="Direct link to ExecuteParams fields">​</a></h4><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>state_libs</td><td>A set of references to external libraries. This mechanism is not supported currently</td></tr><tr><td>block_unixtime</td><td>Current time in Unix Epoch</td></tr><tr><td>block_lt</td><td>Block logical time</td></tr><tr><td>last_tr_lt</td><td>The last transaction logical time</td></tr><tr><td>seed_block</td><td>Random number generator seed</td></tr><tr><td>debug</td><td>Should the TVM output debug information during its execution</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction">Transaction<a href="#transaction" class="hash-link" aria-label="Direct link to Transaction" title="Direct link to Transaction">​</a></h2><p>Transaction is an object that describes the successful execution of
a message on the account.  If a message execution results in an error,
such execution does not lead to a transaction creation.  After
transaction is  created, it gets  sealed into the block.  And after
the block  is negotiated  with fellow validators,  it find  its way
into   the   Masterchain.  From   that   point,   it  stays   there
forever<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.</p><p>Transaction is an  output of the Transaction Executor, so we  have to examine it
more closely.</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Transaction</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> account_addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> lt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> prev_trans_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> prev_trans_lt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> outmsg_cnt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> orig_status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountStatus</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> end_status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountStatus</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">ChildCell</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Message</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> out_msgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">OutMessages</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> total_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CurrencyCollection</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> state_update</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ChildCell</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">HashUpdate</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ChildCell</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">TransactionDescr</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="executeparams-fields-1">ExecuteParams fields<a href="#executeparams-fields-1" class="hash-link" aria-label="Direct link to ExecuteParams fields" title="Direct link to ExecuteParams fields">​</a></h4><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>account_addr</td><td>Account identifier</td></tr><tr><td>lt</td><td>Transaction creation logical time</td></tr><tr><td>prev_trans_hash</td><td>Previous transaction hash value</td></tr><tr><td>prev_trans_lt</td><td>Previous transaction logical time</td></tr><tr><td>now</td><td>Current time in Unix Epoch</td></tr><tr><td>outmsg_cnt</td><td>Number of generated outbound messages</td></tr><tr><td>orig_status</td><td><a href="/arch/accounts#account-state">Account state</a> upon receiving the message</td></tr><tr><td>end_status</td><td><a href="/arch/accounts#account-state">Account state</a> after executing the message</td></tr><tr><td>in_msg</td><td>Processed message</td></tr><tr><td>out_msgs</td><td>Set of generated outbound messages</td></tr><tr><td>total_fees</td><td>Total fee amount for all the processing</td></tr><tr><td>state_update</td><td>Hash footprint of the account state change</td></tr><tr><td>description</td><td><a href="#">Transaction Descriptor</a></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-executor-1">Transaction Executor<a href="#transaction-executor-1" class="hash-link" aria-label="Direct link to Transaction Executor" title="Direct link to Transaction Executor">​</a></h2><p>Transaction Executor module is responsible for applying the incoming message to the destination account, using the supplied parameters. In case of success, Transaction Executor outputs the newly created transaction and the updated account.</p><p>The main entry point is the function execute_with_libs_and_params() within transaction_executor.rs module. Other entry points were either flagged as deprecated, or reduce to calling this function after some minor parameters mangling.</p><p>The message execution is being done in several phases.</p><p>A phase is a logical step during the message execution. It may finish successfully or with an error. In case of an error, the next phase may not be executed. Phases are done mostly in a fixed order, but there are some nuances.</p><p>Let us warn you that the phase is not just an implementation detail of the Transaction Executor internals that may be easily discarded. Message execution phases are a part of EverScale smart-contracts programming architecture. It is assumed that you have a good grasp on it, to be able to do proper troubleshooting in case something is not working as expected. Without this knowledge, it may be challenging to debug the problem.</p><p>This document aims to support programmers in their strive for this knowledge.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-executor-message-processing-general-scheme">Transaction executor message processing general scheme<a href="#transaction-executor-message-processing-general-scheme" class="hash-link" aria-label="Direct link to Transaction executor message processing general scheme" title="Direct link to Transaction executor message processing general scheme">​</a></h4><img loading="lazy" src="https://www.plantuml.com/plantuml/png/LOzD2i8m48NtSuf7zu9UG51nMRhG2mp9M88sgVa1GNftcwPYNCsRB_FUJCBTs94z3nXPQsDxxBP4D_CGj182zq9hnMQFgsSRM4NZBD4pIH8qNOeOoaXem05TIwJOQvnVeb9q7cy25bBv5mZCBXjnyg9DhC1bjkNTrOWRnXJ5L-XG3lc1eqjM2IsaHEQZwwnLP_mN-6toGnLRP8PhT8P5PZZ_59Xe-W00" class="img_ev3q"><ul><li><code>Credit</code> — Message coins are put on the balance
agent Storage.</li><li><code>Storage</code> — Storage fee is deducted from the balance
agent Computer.</li><li><code>Computer</code> — The contract bytecode gets executed inside TVM with proper parameters. Contract generate Actions.</li><li><code>Action</code> — Generated actions get executed by the action handler, producing outbound messages.</li><li><code>Bounce</code> — Bounce phase is executed if failure happened on compute phase or action phase. It sends back the reply with coins, mostly.</li><li><code>Out messages</code> — Queue get propagated to other validators.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-executor-types">Transaction Executor Types<a href="#transaction-executor-types" class="hash-link" aria-label="Direct link to Transaction Executor Types" title="Direct link to Transaction Executor Types">​</a></h3><p>There are several type of messages in EverScale. Besides already mentioned ordinary messages, there are also a special type of messages that is a part of a wider protocol. For example, TickTock messages, SplitMerge messages, etc.</p><p>For each type of messages, there exists a separate Transaction Executor. In this work, we consider only the OrdinaryTransactionExecutor, that is defined in <a href="https://github.com/tonlabs/ton-labs-executor/blob/a28bde3e65dd35573d34e32aa4477d60162b5338/src/ordinary_transaction.rs" target="_blank" rel="noopener noreferrer">ordinary_transaction.rs</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="main-entry-point">Main Entry Point<a href="#main-entry-point" class="hash-link" aria-label="Direct link to Main Entry Point" title="Direct link to Main Entry Point">​</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">execute_with_libs_and_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    in_msg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Message</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_root</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Cell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ExecuteParams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Transaction</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="executeparams-fields-2">ExecuteParams fields<a href="#executeparams-fields-2" class="hash-link" aria-label="Direct link to ExecuteParams fields" title="Direct link to ExecuteParams fields">​</a></h4><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>self</td><td>Reference to the object calling the function</td></tr><tr><td>in_msg</td><td>Incoming message <a href="/arch/message">messages</a></td></tr><tr><td>account_root</td><td>Account record serialized in a form of Cells <a href="/arch/accounts">account</a></td></tr><tr><td>params</td><td>Transaction Executor parameters <a href="#parameters">parameters</a></td></tr></tbody></table><p>As a result, the function  returns either <code>Ok(Transaction)</code> object or <code>Err</code> value.  Please  note that  besides returning  the Transaction, there is a side-effect of  mutating the <code>account_root</code> object. This justifies  our  generalization that  it  returns  two objects:  the transaction and the updated account record.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockchainconfig-parameters">BlockchainConfig parameters<a href="#blockchainconfig-parameters" class="hash-link" aria-label="Direct link to BlockchainConfig parameters" title="Direct link to BlockchainConfig parameters">​</a></h3><p>Besides  ExecuteParams, the  Transaction Executor  relies on  BlockchainConfig parameters.  They are passed  implicitly, at the Transaction Executor creation time.</p><p>BlockchainConfig  is   a  set   of  globally   defined  parameters
regulating  different nuances  of  blockchain  work. For  example,
prices for smart-contract  execution, storage and a  set of system
contract addresses.  The latter  is needed  to let  Transaction Executor apply
special logic for them.</p><p>Those parameters are global to the network, and negotiated between
all the validators in advance. They are stored in a special system
smart-contract, in the Masterchain.</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">BlockchainConfig</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gas_prices_mc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">GasLimitsPrices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gas_prices_wc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">GasLimitsPrices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fwd_prices_mc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">MsgForwardPrices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fwd_prices_wc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">MsgForwardPrices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage_prices</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccStoragePrices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  special_contracts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">FundamentalSmcAddresses</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  global_version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  raw_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ConfigParams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>gas_prices_mc</td><td>Fees for Masterchain smart-contract execution</td></tr><tr><td>gas_prices_wc</td><td>Fees for Workchain smart-contract execution</td></tr><tr><td>fwd_prices_mc</td><td>Fees for delivering messages in Masterchain</td></tr><tr><td>fwd_prices_wc</td><td>Fees for delivering messages in Workchain</td></tr><tr><td>storage_prices</td><td>Fees for information storage</td></tr><tr><td>special_contracts</td><td>Set of system smart-contract addresses</td></tr><tr><td>capabilities</td><td>Set of operation-mode flags</td></tr><tr><td>global_version</td><td>Minimum blocks version number allowed to be included in the chain</td></tr><tr><td>raw_config</td><td>Dictionary with blockchain settings</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-execution-fee">Code Execution Fee<a href="#code-execution-fee" class="hash-link" aria-label="Direct link to Code Execution Fee" title="Direct link to Code Execution Fee">​</a></h3><p>As  in  most  of  blockchain,  in Everscale  the  execution  of  a
smart-contract costs money.  Usually, this fee is deduced from the
coins attached to  the message initiating the call,  but there are
nuances.</p><p>The fee amount to be deducted from the balance is calculated based
on values found in <code>gas_price_mc</code>, <code>gas_price_wc</code>  structures. They
are defined as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">GasLimitsPrices</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> special_gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_credit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> block_gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> freeze_due_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> delete_due_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> flat_gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> flat_gas_price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> max_gas_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>gas_price</td><td>Price of 1 unit of gas, expressed in Nano Evers</td></tr><tr><td>gas_limit</td><td>Maximum gas amount for execution of a single message for an ordinary account</td></tr><tr><td>special_gas_limit</td><td>Maximum gas amount for execution of a single message for a system account</td></tr><tr><td>gas_credit</td><td>Gas credited for an account to execute the external message</td></tr><tr><td>block_gas_limit</td><td>Maximum gas amount of the whole block</td></tr><tr><td>freeze_due_limit</td><td>Value of an account debt leading to account freeze</td></tr><tr><td>delete_due_limit</td><td>Value of an account debt leading to account removal</td></tr><tr><td>flat_gas_limit</td><td></td></tr><tr><td>flat_gas_price</td><td></td></tr><tr><td>max_gas_threshold</td><td></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="message-passing-fee">Message Passing Fee<a href="#message-passing-fee" class="hash-link" aria-label="Direct link to Message Passing Fee" title="Direct link to Message Passing Fee">​</a></h3><p>Validators do  the work  of message  delivery. To  compensate their
efforts,  account  pays  for  the message  passing.   The  message
passing  fee depends  on BlockchainConfig  parameters <code>fwd_prices</code>
and  the message  size.  The  <code>fwd_prices_mc</code> and  <code>fwd_prices_wc</code>
have the following definition:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">MsgForwardPrices</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> lump_price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> bit_price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> cell_price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> ihr_price_factor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> first_frac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> next_frac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The fee amount is calculated using the expression:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>s</mi><mi>g</mi><mi mathvariant="normal">_</mi><mi>f</mi><mi>w</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>f</mi><mi>e</mi><mi>e</mi><mi>s</mi><mo>=</mo><mi>l</mi><mi>u</mi><mi>m</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>+</mo><mi>b</mi><mi>i</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>×</mo><mi>m</mi><mi>s</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>+</mo><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>×</mo><mi>m</mi><mi>s</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">msg\_fwd\_fees = lump\_price + bit\_price \times msg.bits + cell\_price \times msg.cells</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">ees</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord">.</span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord">.</span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">s</span></span></span></span></span></p><p>Here, <code>msg.bits</code> — bit-length of  the message body, <code>msg.cells</code> is a total amount of cells that this message consists of.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-storage-fee">Data Storage Fee<a href="#data-storage-fee" class="hash-link" aria-label="Direct link to Data Storage Fee" title="Direct link to Data Storage Fee">​</a></h3><p>In Everscale, account is charged a  fee for storing the data.  The
fee amount is calculated using the formula:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>e</mi><mi>e</mi><mo>=</mo><mo stretchy="false">(</mo><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi>s</mi><mo>∗</mo><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>+</mo><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>∗</mo><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo><mo>∗</mo><mi mathvariant="normal">Δ</mi></mrow><annotation encoding="application/x-tex">fee = (cells * prices.cell\_price + bits * prices.bit\_price) * \Delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">ee</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ces</span><span class="mord">.</span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ces</span><span class="mord">.</span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">Δ</span></span></span></span></span></p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi></mrow><annotation encoding="application/x-tex">\Delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">Δ</span></span></span></span></span> —  the time interval  between now and the  latest payment
moment, measured in  seconds. Here, we assume  that storage prices
stay constant  during the <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi></mrow><annotation encoding="application/x-tex">\Delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">Δ</span></span></span></span></span> interval. The storage fee gets
charged on each message processing <a href="#storage-phase">storage_phase</a>.</p><p>For  greater  flexibility,  the  storage  prices  may  be  changed
depending on  the current supply/demand  situation. It is  done by
negotiating new blockchain  config parameters <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">prices.cell\_price</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ces</span><span class="mord">.</span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span></span></span></span></span>
and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">prices.bit\_price</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ces</span><span class="mord">.</span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span></span></span></span></span> among  validators. After validators accept
it,  new   parameters  are  written  in   the  Masterchain  config
smart-contract.</p><p>After the  change, previous price  parameters do no get  lost. The
whole history  of storage price  changes is stored in  the config.
It is done to provide precise  calculation of the storage fee that
take into  account all  the price changes  during the  interval of
calculation.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-storage-fee-calculation">Data Storage Fee Calculation<a href="#data-storage-fee-calculation" class="hash-link" aria-label="Direct link to Data Storage Fee Calculation" title="Direct link to Data Storage Fee Calculation">​</a></h4><p>Here we describe the storage fee calculation expression in its generality.</p><p>Lets assume we have the following list of prices equipped
with a timestamp of a moment when the price change took place:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>t</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>t</mi><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>t</mi><mi>N</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">T = \{ t_0, t_1, ..., t_N \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span></p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>r</mi><mo>=</mo><mo stretchy="false">⟨</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>t</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>t</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mi>N</mi></msub><mo separator="true">,</mo><msub><mi>t</mi><mi>N</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">Pr = \langle (pr_0, t_0), (pr_1, t_1), ..., (pr_N, t_N) \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">⟨(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)⟩</span></span></span></span></span></p><p>Here, <code>pr_0</code> is reserved for the initial prices set in the genesis block of the blockchain, and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">t_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> is a timestamp of
those initial prices being set.</p><p>Let <code>now</code> denote the current  timestamp, i.e. the moment of time when we want to calculate the storage fee, measured in Unix Epoch.</p><p>Its value is always greater or equal than the most recent price change timestamp.</p><p>Let <code>last_paid</code> denote  the timestamp of  the latest  storage
payment. If the payment didn&#x27;t take place, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>a</mi><mi>i</mi><mi>d</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">last\_paid = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span></span>.</p><p>To simplify  the calculation formula,  let us introduce a new list
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msup><mi>r</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">Pr&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>, such that:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msup><mi>r</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mo stretchy="false">⟨</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>t</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mi>N</mi></msub><mo separator="true">,</mo><msub><mi>t</mi><mi>N</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">Pr&#x27; = \langle (pr_k, t_k), ..., (pr_N, t_N) \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">⟨(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)⟩</span></span></span></span></span></p><p>where <code>t_k</code> is the  least timestamp among values <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><msub><mi>t</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">t_1 ... t_N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">...</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> that is <code>greater</code>  than  <code>last_paid</code>.</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>k</mi></msub><mo>=</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">{</mo><msub><mi>t</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>t</mi><mi>i</mi></msub><mo>∈</mo><mi>T</mi><mo>∧</mo><msub><mi>t</mi><mi>i</mi></msub><mo>&gt;</mo><mi>l</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>a</mi><mi>i</mi><mi>d</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">t_k = min \{ t_i | t_i \in T \land t_i &gt; last\_paid \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">min</span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">d</span><span class="mclose">}</span></span></span></span></span></p><p>In  other words, the  values <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>k</mi></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>t</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">t_k, ..., t_N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> form  a subset  of
<code>T</code> where each  value is  strictly greater than <code>last_paid</code>.</p><p>We also add two more elements  from the left and the right:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msup><mi>r</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo>=</mo><mo stretchy="false">⟨</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mi>k</mi></msub><mo separator="true">,</mo><mi>l</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>a</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">⟩</mo><mo>⋅</mo><mi>P</mi><msup><mi>r</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>⋅</mo><mo stretchy="false">⟨</mo><mo stretchy="false">(</mo><mi>p</mi><msub><mi>r</mi><mi>N</mi></msub><mo separator="true">,</mo><mi>n</mi><mi>o</mi><mi>w</mi><mo stretchy="false">)</mo><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">Pr&#x27;&#x27; = \langle (pr_k, last\_paid) \rangle \cdot Pr&#x27; \cdot \langle (pr_N, now) \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em"></span><span class="mopen">⟨(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">d</span><span class="mclose">)⟩</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7519em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">⟨(</span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mclose">)⟩</span></span></span></span></span></p><p>Here, dot operator denotes lists concatenation operation.</p><p>We  use the following shortcuts: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><msub><mi>r</mi><mi>i</mi></msub><mo>=</mo><mi>f</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>P</mi><msubsup><mi>r</mi><mi>i</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">pr_i = fst(Pr&#x27;&#x27;_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0106em;vertical-align:-0.2587em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-2.4413em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> the first element  of a two-element tuple, and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><mi>s</mi><mi>n</mi><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><msubsup><mi>r</mi><mi>i</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">t_i = snd(Pr&#x27;&#x27;_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0106em;vertical-align:-0.2587em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-2.4413em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, the second element.</p><p>The total storage fee for the time interval is:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>f</mi><mi>e</mi><mi>e</mi><mo>=</mo><msub><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1..</mn><mi mathvariant="normal">∣</mi><mi>P</mi><msup><mi>r</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mi mathvariant="normal">∣</mi></mrow></msub><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi>s</mi><mo>∗</mo><mi>p</mi><msub><mi>r</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><mi>c</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>+</mo><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi><mo>∗</mo><mi>p</mi><msub><mi>r</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo><mo>∗</mo><mo stretchy="false">(</mo><msub><mi>t</mi><mi>i</mi></msub><mo>−</mo><msub><mi>t</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">total\_storage\_fee = \sum_{i=1..|Pr&#x27;&#x27;|}{(cells * pr_{i}.cell\_price + bits * pr_{i}.bits\_price) * (t_i - t_{i-1})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em">or</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">e</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">ee</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2247em;vertical-align:-0.4747em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2253em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1..∣</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em"><span style="top:-2.786em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′′</span></span></span></span></span></span></span></span></span><span class="mord mtight">∣</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal">ce</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-storage-fee-calculation-algorithm">Data Storage Fee Calculation Algorithm<a href="#data-storage-fee-calculation-algorithm" class="hash-link" aria-label="Direct link to Data Storage Fee Calculation Algorithm" title="Direct link to Data Storage Fee Calculation Algorithm">​</a></h4><p>For greater  convenience, besides  having the formula,  we provide
the pseudo-code for  the algorithm <code>calc_storage_fee</code>, implemented
in imperative fashion.</p><p><strong><em>Input:</em></strong></p><ul><li><code>config</code> — current blockchain configuration, has type <a href="#blockchainconfig-parameters">BlockchainConfig</a></li><li><code>storage_info</code> — the account storage info struct, has type <a href="/arch/accounts#account-storage">StorageInfo</a>.</li><li><code>is_masterchain</code> — is the account inhabits Masterchain or not, has type Bool</li><li><code>now</code> — current time, measured in Unix Epoch, has type UInt</li></ul><p><strong><em>Output</em></strong>:</p><ul><li>fee — the fee amount to be deducted from the account balance, has type UInt</li><li>storage_info — updated account storage info, has type <a href="/arch/accounts#account-storage">StorageInfo</a></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calc_storage_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storage_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_masterchain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cells </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">used</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">used</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_paid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_paid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_prices   </span><span class="token comment" style="color:#999988;font-style:italic"># see AccStoragePrices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> now </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> last_paid </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> last_paid </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> now </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utime_since</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># calculate the fee according to prices that were actual</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># during the specific period of time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cur_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utime_since</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> last_paid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            delta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cur_price</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utime_since</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_paid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> is_masterchain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fee </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cells </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cur_price</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mc_cell_prices_ps </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    bits </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cur_price</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mc_bit_price_ps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> delta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fee </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cells </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cur_price</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cell_price_ps </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    bits </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cur_price</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bit_price_ps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> delta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_paid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storage_info</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="special-smart-contracts">Special Smart-Contracts<a href="#special-smart-contracts" class="hash-link" aria-label="Direct link to Special Smart-Contracts" title="Direct link to Special Smart-Contracts">​</a></h3><p>In Everscale blockchain, there is  a set of  smart-contracts that have a  distinguished status in  the system. For  those contracts, validators are obligated  to process their execution in a special priveledged  manner. Such  smart-contracts are called <code>special</code> or <code>system</code>. Accounts storing those contracts are called the same.</p><p>Special smart-contracts enjoy the following privilege:</p><ul><li>No fee gets deducted for the code execution</li><li>No fee gets deducted for the storage use</li><li>No fee gets deducted for message passing</li><li>It has a special maximum gas limit, see <code>GasLimitsPrices.special_gas_limit</code></li><li>Allowed to process <code>TickTock</code> timer messages</li></ul><p>Upon executing a  message for one of those  special contracts, the Transaction Executor has to apply all those conditions.</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In this document, we mainly focus on ordinary accounts, leaving the special accounts processing details aside.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="globalcapabilities-options">GlobalCapabilities Options<a href="#globalcapabilities-options" class="hash-link" aria-label="Direct link to GlobalCapabilities Options" title="Direct link to GlobalCapabilities Options">​</a></h3><p>There  are  several  flags   defining  different  aspects  of  the blockchain   node   operation   mode.    They   are   defined   in GlobalCapabilities enumeration.</p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>CapCreateStatsEnabled</td><td>Allow update block statistics. Not related to Transaction Executor.</td></tr><tr><td>CapBounceMsgBody</td><td>Include the first 256 bits of the original message in the bounce message body.</td></tr><tr><td>CapReportVersion</td><td>Include the blockchain version info into the block.</td></tr><tr><td>CapShortDequeue</td><td>Some special mode of managing outbound messages by the Validator. Not related to Transaction Executor</td></tr><tr><td>CapFastStorageStat</td><td>Use alternative algorithm to update the structs AccountsStat.</td></tr><tr><td>CapInitCodeHash</td><td>Use the field init_code_hash in the AccountState.</td></tr><tr><td>CapOffHypercube</td><td>Turn off Hypercube routing algorithm for message delivery</td></tr><tr><td>CapMycode</td><td>Provide the virtual machine with the code of a smart-contract being executed.</td></tr><tr><td>CapMbppEnabled</td><td>Not used</td></tr><tr><td>CapIhrEnabled</td><td>Not used</td></tr><tr><td>CapSplitMergeTransactions</td><td>Not used</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rawconfig-options">RawConfig options<a href="#rawconfig-options" class="hash-link" aria-label="Direct link to RawConfig options" title="Direct link to RawConfig options">​</a></h3><p>Besides already  mentioned options, there  are yet another  set of options residing in the <code>BlockchainConfig.raw_config</code>. This field has the following structure:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">ConfigParams</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> config_addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> config_params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">HashmapE</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// &lt;u32, SliceData&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>config_addr</code> — is the configuration smart-contract account identifier (the workchain identifier equals - 1);</li><li><code>config_params</code> — dictionary with parameters, dictionary keys refers to an option number. We will not go deep into those options, because they are not relevant to our work.</li></ul><p>See <a href="https://github.com/tonlabs/ton-labs-block/blob/4b34a73619b53ebda37f3cb6cc44d26925053219/src/config_params.rs#L38" target="_blank" rel="noopener noreferrer">ton-labs-block/src/config_params.rs</a> for further investigation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="error-code-enumeration">Error Code Enumeration<a href="#error-code-enumeration" class="hash-link" aria-label="Direct link to Error Code Enumeration" title="Direct link to Error Code Enumeration">​</a></h3><p>When Transaction Executor encounters an error during message processing, it returns a special answer to the calling side. The answer contains an error code. Here we list possible error codes and their short description. In our further discussion, we rely on those mnemonic names.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="error-code-enumeration-1">Error Code Enumeration<a href="#error-code-enumeration-1" class="hash-link" aria-label="Direct link to Error Code Enumeration" title="Direct link to Error Code Enumeration">​</a></h3><p>When Transaction Executor encounters an error during message processing, it returns a special answer to the calling side. The answer contains an error code. Here we list possible error codes and their short description. In our further discussion, we rely on those mnemonic names.</p><table><thead><tr><th>Error Mnemonic Name</th><th>Description</th></tr></thead><tbody><tr><td>InvalidExtMessage</td><td>Incorrect format of an incoming external message</td></tr><tr><td>TrExecutorError(e)</td><td>Wide range of errors during message processing</td></tr><tr><td>TvmExceptionCode(e)</td><td>TVM produced exception e during byte-code execution</td></tr><tr><td>NoAcceptError</td><td>The smart-contract did not accept external message</td></tr><tr><td>NoFundsToImportMsg</td><td>Not enough funds to process external message</td></tr><tr><td>ExtMsgComputeSkipped(r)</td><td>During the external message processing, the Compute phase was skipped with the reason r</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="account-state-update">Account State Update<a href="#account-state-update" class="hash-link" aria-label="Direct link to Account State Update" title="Direct link to Account State Update">​</a></h3><p>In the transaction object, there is a special field reflecting the change of the account state, the <code>state_update</code> field of type <code>HashUpdate</code>.</p><p>The type is defined as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">HashUpdate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> old_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> new_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here <code>old_hash</code> refers to a hash value taken from the initial account state, before message processing; the <code>new_hash</code> is a hash taken from the updated account state, after successful message processing.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-description-object">Transaction Description Object<a href="#transaction-description-object" class="hash-link" aria-label="Direct link to Transaction Description Object" title="Direct link to Transaction Description Object">​</a></h3><p>During the incoming message processing, Transaction Executor constructs the report about the processing. This report has a special name — Transaction Description,
and defined by the following structure:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TransactionDescrOrdinary</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> credit_first</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> storage_ph</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">TrStoragePhase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> credit_ph</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">TrCreditPhase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> compute_ph</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">TrComputePhase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">TrActionPhase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> aborted</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> bounce</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">TrBouncePhase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> destroyed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This description object may be used for fast checkups on the main system invariants, critical for its safety, during runtime.</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>storage_ph</td><td><a href="#storage-phase-descriptor">Storage phase descriptor</a></td></tr><tr><td>credit_ph</td><td><a href="#credit-phase-descriptor">Credit phase descriptor</a></td></tr><tr><td>compute_ph</td><td><a href="#compute-phase-descriptor">Compute phase descriptor</a></td></tr><tr><td>action</td><td><a href="#action-phase-descriptor">Action phase descriptor</a></td></tr><tr><td>bounce</td><td><a href="#bounce-phase-transaction-descriptor">Bounce phase descriptor</a></td></tr><tr><td>credit_first</td><td>Credit phase was executed before Storage phase</td></tr><tr><td>aborted</td><td>Is Action phase failed</td></tr><tr><td>destroyed</td><td>Is account <code>deleted</code>  after message execution</td></tr></tbody></table><p>We now describe each descriptor separately.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-phase-descriptor">Storage Phase Descriptor<a href="#storage-phase-descriptor" class="hash-link" aria-label="Direct link to Storage Phase Descriptor" title="Direct link to Storage Phase Descriptor">​</a></h4><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrStoragePhase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> storage_fees_collected</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Grams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> storage_fees_due</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Grams</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> status_change</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccStatusChange</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>storage_fees_collected</code> denotes the amount of tokens deducted from the account balance to cover the storage fee.</li><li><code>storage_fees_due</code> denotes the debt value, if there is any. Otherwise, this value equals <code>None</code>.</li><li><code>status_change</code> denotes the possible account status change. It may
have been the case that the status were frozen or deleted due to
having a significant debt value. Possible values are:</li></ul><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">AccStatusChange</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Unchanged</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Frozen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Deleted</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="credit-phase-descriptor">Credit Phase Descriptor<a href="#credit-phase-descriptor" class="hash-link" aria-label="Direct link to Credit Phase Descriptor" title="Direct link to Credit Phase Descriptor">​</a></h4><p>The Credit Phase descriptor is defined as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrCreditPhase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> due_fees_collected</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Grams</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> credit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CurrencyCollection</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>due_fees_collected</code></td><td>Amount of coins deducted from the message balance to cover the debt of the account, if any existed at the <em>beginning of the credit phase</em>. If there were no debt, the value is <code>None</code> .</td></tr><tr><td><code>credit</code></td><td>Message value after the fees were conducted from it.</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="compute-phase-descriptor">Compute Phase Descriptor<a href="#compute-phase-descriptor" class="hash-link" aria-label="Direct link to Compute Phase Descriptor" title="Direct link to Compute Phase Descriptor">​</a></h4><p>Compute Phase descriptor is defined with the following enumeration:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">TrComputePhase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Skipped</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TrComputePhaseSkipped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Vm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TrComputePhaseVm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="choice-1-skipped">Choice 1. Skipped<a href="#choice-1-skipped" class="hash-link" aria-label="Direct link to Choice 1. Skipped" title="Direct link to Choice 1. Skipped">​</a></h5><p>If the Compute phase was not successfully performed, the descriptor value is <code>Skipped</code>
in this case. It should have an argument with following type:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrComputePhaseSkipped</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ComputeSkipReason</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>reason</code> has to be one of the following:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">ComputeSkipReason</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">NoState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">BadState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">NoGas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>NoState</td><td>Caused by the following conditions: 1) The account did not exist by the time of message arrival, and the incoming message did not contain the <code>StateInit</code> part; 2) The account was not initialized and the incoming message did not contain the <code>StateInit</code>  part.</td></tr><tr><td>NoState</td><td>Caused by the following conditions: 1) The account did not exist by the time of message arrival, and the incoming message did not contain the <code>StateInit</code> part; 2) The account was not initialized and the incoming message did not contain the <code>StateInit</code>  part.</td></tr><tr><td>BadState</td><td>Caused by the following conditions: 1) The account was in <code>AccStateUninit</code> state, the message did contain the <code>StateInit</code> part, but an attempt to initialize the account with the given <code>StateInit</code> failed due to being inconsistent with the account; 2) The account was in <code>AccStateFrozen</code> state, the message contained the <code>StateInit</code> part, but an attempt to unfreeze the account with the given state init failed due to being inconsistent with the account.</td></tr><tr><td>NoGas</td><td>Caused by the following conditions: 1) After Credit and Storage phases, the account balance had no coins: its balance equals zero; 2) Values <code>gas_limit</code> and <code>gas_credit</code>, calculated with the <a href="#initial-gas-algorithm">init_gas</a> algorithm, both equals 0.</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_LWe7" id="choice-2-successful-computation">Choice 2. Successful computation<a href="#choice-2-successful-computation" class="hash-link" aria-label="Direct link to Choice 2. Successful computation" title="Direct link to Choice 2. Successful computation">​</a></h5><p>Successful Compute phase result is defined by the following <code>TrComputePhaseVm</code>  structure:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrComputePhaseVm</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> msg_state_used</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> account_activated</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Grams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_used</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">VarUInteger7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">VarUInteger7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> gas_credit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">VarUInteger3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> exit_code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> exit_arg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> vm_steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> vm_init_state_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> vm_final_state_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>success</td><td>Compute phase completion status. See <a href="#compute-phase-success-conditions">compute_phase_success</a></td></tr><tr><td>gas_fees</td><td>Fees for the gas used by a smart-contract execution, <a href="#calculate-gas-fee-algorithm">see here</a></td></tr><tr><td>gas_used</td><td>An exact amount of gas used by the VM during the execution</td></tr><tr><td>gas_limit</td><td>A strict upper bound on the amount of gas allowed for this account <a href="#initial-gas-algorithm">init_gas</a></td></tr><tr><td>gas_credit</td><td>An amount of gas credited to be used for external messages before being accepted <a href="#initial-gas-algorithm">init_gas</a></td></tr><tr><td>vm_steps</td><td>Number of steps performed by the VM</td></tr><tr><td>exit_code</td><td>Computation exit code, see <a href="#compute-phase-exit-code">compute_phase_exitcode</a></td></tr><tr><td>exit_arg</td><td>Computation exit argument, see <a href="#compute-phase-exit-code">compute_phase_exitcode</a></td></tr><tr><td>mode</td><td>Always equals 0</td></tr><tr><td>vm_init_state_hash</td><td>Not used</td></tr><tr><td>vm_final_state_hash</td><td>Not used</td></tr><tr><td>msg_stated_used</td><td>Not used</td></tr><tr><td>account_activated</td><td>Not used</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="action-phase-descriptor">Action Phase Descriptor<a href="#action-phase-descriptor" class="hash-link" aria-label="Direct link to Action Phase Descriptor" title="Direct link to Action Phase Descriptor">​</a></h4><p>Action Phase descriptor is defined as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrActionPhase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> valid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> no_funds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> status_change</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccStatusChange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> total_fwd_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Grams</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> total_action_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Grams</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> result_code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> result_arg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> tot_actions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> spec_actions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> skipped_actions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> msgs_created</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> action_list_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UInt256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> tot_msg_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">StorageUsedShort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>success</td><td>Action phase completed successfully. The success condition is described <a href="#action-phase-success-condition">here</a>.</td></tr><tr><td>valid</td><td>Action phase is valid. The validity condition is described <a href="#action-phase-validity-condition">here</a>.</td></tr><tr><td>result_code</td><td>Action phase failed with the result code, see <a href="#action-result-codes">action_result_codes</a>. In case of success, the value equals to 0</td></tr><tr><td>result_arg</td><td>In case of an error, the item number of an action in the action list that caused the error</td></tr><tr><td>no_funds</td><td>True if the error was caused by a balance insufficiency</td></tr><tr><td>status_change</td><td>Equals AccStatusChange::Deleted in case of the account being deleted after processing actions</td></tr><tr><td>total_fwd_fees</td><td>Total fees for the SendMsg actions processing</td></tr><tr><td>total_action_fees</td><td>Total fees for the whole action list processing</td></tr><tr><td>tot_actions</td><td>Total number of actions in the action list at a beginning of the Action phase</td></tr><tr><td>spec_actions</td><td>Number of special actions, i.e. Reserve, SetCode, SetLib</td></tr><tr><td>msg_created</td><td>Number of successful SendMsg actions</td></tr><tr><td>action_list_hash</td><td>Hash of action list calculated at a beginning of the Action phase</td></tr><tr><td>tot_msg_size</td><td>Total size of all the generated messages</td></tr><tr><td>skipped_actions</td><td>Not used</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="action-result-codes">Action Result Codes<a href="#action-result-codes" class="hash-link" aria-label="Direct link to Action Result Codes" title="Direct link to Action Result Codes">​</a></h4><table><thead><tr><th>Result Code</th><th>Description</th></tr></thead><tbody><tr><td>RESULT_CODE_ACTIONLIST_INVALID</td><td>Message serialization error</td></tr><tr><td>RESULT_CODE_TOO_MANY_ACTIONS</td><td>Contract generated more actions than allowed. Maximum actions count is 255</td></tr><tr><td>RESULT_CODE_UNKNOWN_OR_INVALID_ACTION</td><td>Binary serialization error, or invalid flags. See <a href="#remarks">remarks</a>.</td></tr><tr><td>RESULT_CODE_INCORRECT_SRC_ADDRESS</td><td>Wide source address <a href="/arch/accounts#account-address">address</a>, or the source address does not equal to the account address</td></tr><tr><td>RESULT_CODE_INCORRECT_DST_ADDRESS</td><td>Incorrect destination address, or destination workchain is not allowed to receive messages, or destination workchain does not exist</td></tr><tr><td>RESULT_CODE_ANYCAST</td><td>Destination address of type Anycast. It is no longer supported and considered an error.</td></tr><tr><td>RESULT_CODE_NOT_ENOUGH_GRAMS</td><td>Insufficient balance. See <a href="#remarks">remarks</a>.</td></tr><tr><td>RESULT_CODE_NOT_ENOUGH_EXTRA</td><td><a href="#multicurrency-payments">Extra-tokens</a> balance is insufficient to execute to action</td></tr><tr><td>RESULT_CODE_INVALID_BALANCE</td><td>Reserve action lead to an error, or outgoing message is too big to process</td></tr><tr><td>RESULT_CODE_BAD_ACCOUNT_STATE</td><td>Actions SetCode or ChangeLib lead to an error</td></tr><tr><td>RESULT_CODE_UNSUPPORTED</td><td>SendMsg action has incorrect flags set</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_LWe7" id="remarks">Remarks:<a href="#remarks" class="hash-link" aria-label="Direct link to Remarks:" title="Direct link to Remarks:">​</a></h5><ol><li><code>RESULT_CODE_UNKNOWN_OR_INVALID_ACTION</code>  reasons are:</li></ol><ul><li>Actions serialization error</li><li>SendMsg action has invalid flags, that is:<ul><li>The mutually exclusive flags are set: <code>SENDMSG_REMAINING_MSG_BALANCE</code> and <code>SENDMSG_ALL_BALANCE</code></li><li>Message was sent with an unknown flag <a href="#action-sendmsg">sendmsg_flags</a>;</li><li>The flag <code>SENDMSG_DELETE_IF_EMPTY</code> is set, but the flag <code>SENDMSG_ALL_BALANCE</code>  isn&#x27;t;</li></ul></li><li>Reserve action has invalid flags<ul><li>Unknown flag is set</li><li>Flag <code>RESERVE_PLUS_ORIG</code> is set, but <code>RESERVE_REVERSE</code>  isn&#x27;t</li></ul></li></ul><ol start="2"><li><code>RESULT_CODE_NOT_ENOUGH_GRAMS</code>  reasons are:</li></ol><ul><li>For SendMsg action, the flag <code>SENDMSG_REMAINING_MSG_BALANCE</code> is set, but <code>SENDMSG_PAY_FEE_SEPARATELY</code>  isn&#x27;t</li><li>Message balance is insufficient to cover message delivery fees</li><li>Account balance is insufficient to cover all message delivery fees</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bounce-phase-transaction-descriptor">Bounce Phase Transaction Descriptor<a href="#bounce-phase-transaction-descriptor" class="hash-link" aria-label="Direct link to Bounce Phase Transaction Descriptor" title="Direct link to Bounce Phase Transaction Descriptor">​</a></h4><p>Bounce Phase descriptor is defined with the following enumeration:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">TrBouncePhase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Negfunds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Nofunds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TrBouncePhaseNofunds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TrBouncePhaseOk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>Negfunds</code> choice is not used.</li><li><code>Nofunds(TrBouncePhaseNofunds)</code> denotes the insufficiency of account balance, details are put into the parameter value</li><li><code>Ok(TrBouncePhaseOk)</code> denotes success, i.e. that the bounce message has been formed and put into the Msg queue. Details of the phase are put into the parameter value.</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="choice-1-nofunds">Choice 1. Nofunds<a href="#choice-1-nofunds" class="hash-link" aria-label="Direct link to Choice 1. Nofunds" title="Direct link to Choice 1. Nofunds">​</a></h5><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrBouncePhaseNofunds</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> msg_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">StorageUsedShort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> req_fwd_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Grams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>msg_size</code>  denotes the size of generated bounce message. This value is not used.</li><li><code>req_fwd_fees</code>  denotes the fee for the message delivery.</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="choice-2-oktrbouncephaseok">Choice 2. Ok(TrBouncePhaseOk)<a href="#choice-2-oktrbouncephaseok" class="hash-link" aria-label="Direct link to Choice 2. Ok(TrBouncePhaseOk)" title="Direct link to Choice 2. Ok(TrBouncePhaseOk)">​</a></h5><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">TrBouncePhaseOk</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> msg_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">StorageUsedShort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> msg_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Grams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> fwd_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Grams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>msg_size</code>  not used.</li><li><code>fwd_fees</code>  is a full forwarding fee for the bounce message.</li><li><code>msg_fees</code> is a part of <code>fwd_fees</code>  that goes to the validator processing the message.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="actions">Actions<a href="#actions" class="hash-link" aria-label="Direct link to Actions" title="Direct link to Actions">​</a></h2><p>After successfully executing a  smart-contract code, the TVM virtual
machine provides  the executor  with updated  contract state  and a
list of actions to be further processed.</p><p>In our  context, an action refers  to an order for  the Transaction Executor to
perform  a  distinguished  stateful  act. It  could  be  sending  a
message, changing  the smart-contract&#x27;s code or  reserving coins on
the balance.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-of-actions">Type of Actions<a href="#type-of-actions" class="hash-link" aria-label="Direct link to Type of Actions" title="Direct link to Type of Actions">​</a></h3><p>Here we provide a set of possible actions, with the description. We
go deep on each of them further.</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">OutAction</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// default value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">SendMsg</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out_msg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">SetCode</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new_code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Cell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">ReserveCurrency</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CurrencyCollection</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">ChangeLibrary</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Cell</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">UInt256</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>Action</th><th>Description</th></tr></thead><tbody><tr><td><code>SendMsg</code></td><td>Send the message out_msg to some account using the provided mode</td></tr><tr><td><code>ReserveCurrency</code></td><td>Manage the account&#x27;s balance to guarantee its sufficiency</td></tr><tr><td><code>SetCode</code></td><td>Change the contract byte-code with the given new_code</td></tr><tr><td><code>ChangeLibrary</code></td><td>Update code library</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-sendmsg">Action SendMsg<a href="#action-sendmsg" class="hash-link" aria-label="Direct link to Action SendMsg" title="Direct link to Action SendMsg">​</a></h3><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>M</mi><mi>s</mi><mi>g</mi><mo stretchy="false">(</mo><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>m</mi></msub><mi>s</mi><mi>g</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SendMsg(mode,out_msg)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mclose">)</span></span></span></span></span> action sends a message to an account. The message <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>s</mi><mi>g</mi></mrow><annotation encoding="application/x-tex">out\_msg</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9251em;vertical-align:-0.31em"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span></span></span></span></span> contains
the destination address as well as the payload to be delivered.</p><p>This action has a lot of  modes that can be combined using logical
<code>OR</code>  operator. Some mode combinations are prohibited. See <a href="#remarks">rc_remarks</a>.</p><table><thead><tr><th>Mode</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>SENDMSG_ORDINARY</code></td><td>0</td><td>Send the message. Without other modes, the forwarding fee for the delivery is paid by the receiver.</td></tr><tr><td><code>SENDMSG_PAY_FEE_SEPARATELY</code></td><td>1</td><td>Send the message. The forwarding fee is paid by the sender.</td></tr><tr><td><code>SENDMSG_IGNORE_ERROR</code></td><td>2</td><td>If an error occurs during the processing of this action, ignore it.</td></tr><tr><td><code>SENDMSG_DELETE_IF_EMPTY</code></td><td>32</td><td>The account gets deleted if, after the action processed, the balance becomes zero</td></tr><tr><td><code>SENDMSG_REMAINING_MSG_BALANCE</code></td><td>64</td><td>The message should carry all the remaining value of the inbound message additionally to the value specified in the field</td></tr><tr><td><code>SENDMSG_ALL_BALANCE</code></td><td>128</td><td>The message should carry all the remaining balance of the account, instead of the value specified in the value field</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-reservecurrency">Action ReserveCurrency<a href="#action-reservecurrency" class="hash-link" aria-label="Direct link to Action ReserveCurrency" title="Direct link to Action ReserveCurrency">​</a></h3><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>C</mi><mi>u</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>y</mi><mo stretchy="false">(</mo><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">ReserveCurrency(mode, val)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal" style="margin-right:0.02778em">eser</span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rre</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em">cy</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mclose">)</span></span></span></span></span> action makes a coin reserve on the balance. This action has several modes of operation.
Modes can be combined.</p><table><thead><tr><th>Mode</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>RESERVE_EXACTLY</code></td><td>0</td><td>Reserve exactly <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span> coins</td></tr><tr><td><code>RESERVE_ALL_BUT</code></td><td>1</td><td>Reserve <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>c</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>−</mo><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">acc\_balance - val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">cc</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span> coins, where <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>c</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">acc\_balance</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">cc</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span></span></span></span></span> is a remaining balance of the account</td></tr><tr><td><code>RESERVE_IGNORE_ERROR</code></td><td>2</td><td>Skip the action on failure</td></tr><tr><td><code>RESERVE_PLUS_ORIG</code></td><td>4</td><td>Reserve <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>c</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>+</mo><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">acc\_balance + val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">cc</span><span class="mord" style="margin-right:0.02778em">_</span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span> coins. It should be used only with RESERVE_REVERSE.</td></tr><tr><td><code>RESERVE_REVERSE</code></td><td>8</td><td>Reverse value of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span> in the calculation of the reserve, i.e. substitute <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span> with <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">-val</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span></span></span></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-setcode">Action SetCode<a href="#action-setcode" class="hash-link" aria-label="Direct link to Action SetCode" title="Direct link to Action SetCode">​</a></h3><p>Currently, we skip this action.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="message-processing-algorithm">Message Processing Algorithm<a href="#message-processing-algorithm" class="hash-link" aria-label="Direct link to Message Processing Algorithm" title="Direct link to Message Processing Algorithm">​</a></h2><p>In this section, we present a pseudo-code for incoming message processing algorithm.</p><p>The algorithm is divided in two mutually exclusive parts:</p><ul><li><code>ExecuteInternalMessage</code> — internal message execution <a href="#internal-message-processing-algorithm">internal_message_processing</a></li><li><code>ExecuteExternalMessage</code> — external message execution <a href="#external-message-processing-algorithm">external_message_processing</a></li></ul><p>Both algorithms rely on executing some or all of the phases:</p><ul><li>Credit phase <a href="#credit-phase">credit_phase</a></li><li>Storage phase <a href="#storage-phase">storage_phase</a></li><li>Compute phase <a href="#compute-phase">compute_phase</a></li><li>Action phase <a href="#action-phase">action_phase</a></li><li>Bounce phase <a href="#bounce-phase">bounce_phase</a></li></ul><p>Please  note that  we consider  only <code>ordinary</code>   accounts here. The algorithm  for  executing  messages   on  special  accounts  is  not considered.</p><p><strong><em>Input:</em></strong></p><ul><li><code>in_msg</code> — incoming message, has type <a href="/arch/message">Message</a></li><li><code>account</code> — account, has type <a href="/arch/accounts">Account</a></li><li><code>params</code> — executor parameters, has type <a href="#parameters">Parameters</a></li><li><code>config</code> — blockchain configuration, has type <a href="#blockchainconfig-parameters">BlockchainConfig</a></li></ul><p><strong><em>Output:</em></strong></p><p>On success, returns <em>Ok(acc1, trans)</em>, such that:</p><ul><li><code>acc1</code> — updated account, has type <a href="/arch/accounts">Account</a></li><li><code>trans</code> — transaction, has type <a href="#transaction">Transaction</a></li></ul><p>On error, returns error of the type <code>ExecutorError</code></p><p><strong><em>Modifies:</em></strong></p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ExecuteMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> ExtOutMsgInfo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvalidExtMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> ExtInMessageHeader </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoFundsToImportMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      acc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> ExtInMsgInfo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecuteExternalMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> IntMsgInfo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecuteInternalMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="internal-message-processing-algorithm">Internal Message Processing Algorithm<a href="#internal-message-processing-algorithm" class="hash-link" aria-label="Direct link to Internal Message Processing Algorithm" title="Direct link to Internal Message Processing Algorithm">​</a></h2><p>At this point, the message is known to be internal. Execute it with the given account.</p><p><strong><em>Input:</em></strong></p><ul><li><code>in_msg</code> — incoming message, has type  <a href="/arch/message">Message</a></li><li><code>account</code> — account, has type <a href="/arch/accounts">Account</a></li><li><code>params</code> — executor parameters, has type <a href="#parameters">Parameters</a></li><li><code>config</code> — blockchain configuration, has type <a href="#blockchainconfig-parameters">BlockchainConfig</a></li></ul><p><strong><em>Output:</em></strong></p><p>On success, returns <em>Ok(acc1, trans)</em>, such that:</p><ul><li><code>acc1</code> — updated account, has type <a href="/arch/accounts">Account</a></li><li><code>trans</code> — transaction, has type <a href="#transaction">Transaction</a> On error, returns error of the type <em>TransactionExecutor.TrExecutorError</em></li></ul><p><em><em>Modifies</em>:</em></p><ul><li><code>account</code></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ExecuteInternalMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msg_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">credit_first </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">account_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">descr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TransactionDescrOrdinary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">credit_first</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> credit_first</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># If the bounce flag is not set, execute the Credit Phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># before Storage phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> credit_first</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          credit_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> credit_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> credit_ph_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">credit_ph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> credit_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">credit_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Execute Storage Phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     is_masterchain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_ph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Why this is needed?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> credit_first </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_balance </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          msg_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      original_acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> credit_first</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          credit_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> credit_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> credit_ph_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">credit_ph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> credit_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">credit_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Both storage and credit phases are completed at this point.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># We need to update the last_paid field not to loose this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># information in case of some further errors showing up.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_paid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">block_unixtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Parameters to be passed into TVM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      smci </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> build_contract_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">block_lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed_block</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># First element is the bottom of the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Stack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Execute Compute Phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compute_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_libs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     smci</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     stack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compute_ph_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      actions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Generated outbound messages to be sent into other accounts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      out_msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compute_gas_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> compute_gas_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          act_phase_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       original_acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       actions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       new_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> act_phase_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> act_phase_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              out_msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> act_phase_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msgs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_change </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Deleted</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">destroyed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aborted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aborted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># If the Action Phase failed, and the incoming message allows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># bounce answer, execute the Bounce Phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aborted </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Vm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              bounce_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  bounce_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               compute_gas_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               my_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> bounce_ph_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bounce_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bounce_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce_msg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      out_msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> out_msgs </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bounce_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce_msg</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> original_acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateUninit </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 acc_balance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_none</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uninit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_paid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               acc_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateUninit </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">acc_end_status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      upd_lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> add_messages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_msgs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_lt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> upd_lt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">descr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> descr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The function <code>add_messages</code>  assigns  the proper logical timestamp for
each  message from  the  out_msgs collection,  and  then include  the
message into the transaction.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_messages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_msgs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lt_next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out_msgs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lt_next </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> msg </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> out_msgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_out_message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           lt_next </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lt_next</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="external-message-processing-algorithm">External Message Processing Algorithm<a href="#external-message-processing-algorithm" class="hash-link" aria-label="Direct link to External Message Processing Algorithm" title="Direct link to External Message Processing Algorithm">​</a></h2><p>The execution of external message on the given account.</p><p><strong><em>Input:</em></strong></p><ul><li><code>in_msg</code> — incoming message, has type <a href="/arch/message">Message</a></li><li><code>account</code> — account, has type <a href="/arch/accounts">Account</a></li><li><code>params</code> — executor parameters, has type <a href="#parameters">Parameters</a></li><li><code>config</code> — blockchain configuration, has type <a href="#blockchainconfig-parameters">BlockchainConfig</a></li></ul><p><strong><em>Output:</em></strong></p><p>On success, returns <em>Ok(acc1, trans)</em>, such that:</p><ul><li><code>acc1</code> — updated account, has type <a href="/arch/accounts">Account</a></li><li><code>trans</code> — transaction, has type <a href="#transaction">Transaction</a> On error, returns error of the type <em>TransactionExecutor.TrExecutorError</em></li></ul><p><em>Modifies:</em></p><ul><li><code>account</code></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ExecuteExternalMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msg_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">is_masterchain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst_workchain_id </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">account_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      descr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TransactionDescrOrdinary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">credit_first</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      in_fwd_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> in_fwd_fee</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoFundsToImportMsg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> in_fwd_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Execute Storage Phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     is_masterchain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_ph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          original_acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          original_acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Credit Phase is skipped for external messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Storage phase is completed at this point</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># We need to update the last_paid field not to loose this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># information in case of some further errors showing up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_paid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">block_unixtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Parameters to be passed into TVM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      smci </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> build_contract_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">block_lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 lt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed_block</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># First element is the bottom of the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Stack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Execute Compute Phase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compute_ph_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_libs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     smci</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     stack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> compute_ph_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Generated outbound messages to be sent into other</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># accounts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      out_msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compute_gas_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> compute_gas_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_ph</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          act_phase_res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       original_acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       accounts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       compute_ph_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> act_phase_res </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> act_phase_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action_ph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              out_msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> act_phase_res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msgs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_change </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Deleted</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">destroyed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aborted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          descr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aborted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># The Bounce Phase is skipped for external messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateUninit </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">acc_end_status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      upd_lt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> add_messages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_msgs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_lt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_tr_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> upd_lt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">descr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> descr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="credit-phase">Credit Phase<a href="#credit-phase" class="hash-link" aria-label="Direct link to Credit Phase" title="Direct link to Credit Phase">​</a></h2><p>At this phase, coins from the message balance goes to the account balance.
This phase is executed only for internal messages. External messages have
no coins attached.</p><p><strong><em>Input:</em></strong></p><ul><li><code>account</code> — account that the message is executed on, <a href="/arch/accounts#account-structure-definition">Account</a></li><li><code>tr</code> — forming transaction, has type <a href="#transaction">Transaction</a></li><li><code>msg_balance</code> — message balance, has type <code>Grams</code></li><li><code>acc_balance</code> — current balance of the account, has type <code>Grams</code></li></ul><p><strong><em>Output:</em></strong></p><p>The phase always succeeds. It returns the value of type:
/Ok(TrCreditPhase(collected, msg_balance))/, such that:</p><ul><li><code>collected</code> — the amount of coins withheld for the account debt, if any.</li><li><code>msg_balance</code> — the amount of coins put on the account balance after the debt fee was conducted.</li></ul><p><strong><em>Modifies:</em></strong></p><ul><li><code>account</code> — updates the <code>due_payment</code>  field with the remaining debt, if any</li><li><code>tr</code> — updates the <code>total_fees</code>  field</li><li><code>msg_balance</code> — the original message balance after the debt conducted, if any</li><li><code>acc_balance</code> — the account balance with message coins</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">credit_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">due_payment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collected </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">due_payment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         msg_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg_balance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> collected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         due_payment_remaining </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> due_payment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> collected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> due_payment_remaining</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fees </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> collected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># put message coins on the account balance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> msg_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrCreditPhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">collected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage-phase">Storage Phase<a href="#storage-phase" class="hash-link" aria-label="Direct link to Storage Phase" title="Direct link to Storage Phase">​</a></h2><p>This phase withholds the storage fee from the account balance. The fee amount
is calculated using the algorithm <code>calc_storage_fee</code>  <a href="#data-storage-fee-calculation-algorithm">calc_storage_fee</a></p><p><strong><em>Input:</em></strong></p><ul><li><code>account</code> — account that the message is executed on, has type <a href="/arch/accounts">Account</a></li><li><code>tr</code> — forming transaction, has type <a href="#transaction">Transaction</a></li><li><code>msg_balance</code> — message balance, has type <code>Grams</code></li><li><code>acc_balance</code> — current balance of the account, has type <code>Grams</code></li><li><code>config</code> — main blockchain parameters, has type <a href="#blockchainconfig-parameters">BlockchainConfig</a></li></ul><p><strong><em>Output:</em></strong></p><p>This phase always succeeds. The return values may differ <code>Ok(TrStoragePhase(collected, fee, status_change))</code>, such that:</p><ul><li><code>collected</code> — the amount of coins withheld for the storage fee</li><li><code>debt</code> — if the balance was insufficient, the remaining debt of the account</li><li><code>status_change</code> — should the account be frozen or deleted afterwards</li></ul><p><em><em>Modifies</em>:</em></p><ul><li><code>account</code> — updates <code>due_payment</code> and <code>status</code>  fields</li><li><code>acc_balance</code> — the current balance after the fee got deducted</li><li><code>tr</code> — updates the <code>total_fee</code>  field</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">storage_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># It is assumed that the current transaction must have a more</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># recent timestamp than the latest payment timestamp.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Otherwise, something is terribly wrong.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">now </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_paid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># The account does not occupy any space, so do not charge the fee</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrStoragePhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calc_storage_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                             is_masterchain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrStoragePhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unchanged</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         storage_fees_collected </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> storage_fees_collected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fee </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> storage_fees_collected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         need_freeze </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fee </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_gas_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_masterchanin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">freeze_due_limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         need_delete </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateUninit </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateFrozen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fee </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_gas_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delete_due_limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> need_delete</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrStoragePhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage_fees_collected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Deleted</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> need_freeze</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateActive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateFrozen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrStoragePhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage_fees_collected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Frozen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrStoragePhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage_fees_collected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unchanged</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">due_payment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrStoragePhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage_fees_collected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unchanged</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compute-phase">Compute Phase<a href="#compute-phase" class="hash-link" aria-label="Direct link to Compute Phase" title="Direct link to Compute Phase">​</a></h2><p>Execute the account smart-contract, update the state, gather generated actions to pass on
the next phase.</p><p><strong><em>Input:</em></strong></p><ul><li><code>msg</code> — message, has type <a href="/arch/message">Message</a></li><li><code>account</code> — account, has type <a href="/arch/accounts">Account</a></li><li><code>acc_balance</code> — current account balance, has type <code>Grams</code></li><li><code>msg_balance</code> — message balance,has type <code>Grams</code></li><li><code>state_libs</code> — code libraries, has type <code>Blob</code>  (not relevant; omitted)</li><li><code>smc_info</code> — extra data for TVM, has type <code>SmartContractInfo</code></li><li><code>stack</code> — TVM initial stack values</li><li><code>is_masterchain</code> — is the account belongs to Masterchain, has type bool</li></ul><p><strong><em>Output:</em></strong></p><ul><li><p>On success, returns <em>Ok(TrComputePhase, out_actions, new_data)</em>,
such that:</p><ul><li><code>TrComputePhase</code> — actual Compute Phase Descriptor</li><li><code>out_actions</code> — an ordered list of generated actions</li><li><code>new_data</code> — updated smart-contract state</li></ul></li><li><p>On error, returns <code>Err(ExecutorError)</code> with proper code.</p></li></ul><p><strong><em>Modifies:</em></strong></p><ul><li><code>account</code> — updated account state</li><li><code>smc_info</code> — mycode field set to point to the code of the smart-contract</li><li><code>acc_balance</code> — account balance after the gas fee deduction</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uninit_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> AccountState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountActive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AccountState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountUninit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compute_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_libs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smc_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      stack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result_acc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TrComputePhaseVm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is_external </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> ExtInMsgInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result_acc </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_acc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account_from_message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> new_acc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result_acc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result_acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_paid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> smc_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unix_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uninit_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrComputePhase</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">skipped</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoGas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gas_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_gas_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> init_gas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_external</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Is it possible?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> gas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_limit </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> gas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_credit </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrComputePhase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">skipped</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoGas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            libs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state_init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result_acc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_new_state</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> reason </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrComputePhase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">skipped</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reason</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_credit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_credit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result_acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">code </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> is_external</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoAcceptError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calc_gas_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            acc_balance </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrComputePhase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Vm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vm_phase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result_acc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">libraries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># local libraries</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_libs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># masterchain libraries</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        smc_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mycode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Here, we initialize abstract TVM virtual machine.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># The exact behavior of this device is out of scope.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TVM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smc_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> smc_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">libraries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commited_state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_committed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># vm.gas may have been updated after the execution</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gas_vm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># how much credited gas remains unspent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        credit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas_vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_credit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        used </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas_vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_used</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_used </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> used</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> credit </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> is_external</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># The smart-contract has to explicitly accept the external message,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># otherwise it gets rejected. The acceptance of a message manifests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># itself in the credit field being equal to 0.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoAcceptError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gas_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calc_gas_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">used</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vm_steps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">steps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commited_state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> new_data </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out_actions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> out_actions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vm_phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrComputePhase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Vm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vm_phase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_actions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compute-phase-success-conditions">Compute Phase Success Conditions<a href="#compute-phase-success-conditions" class="hash-link" aria-label="Direct link to Compute Phase Success Conditions" title="Direct link to Compute Phase Success Conditions">​</a></h3><p>We  would like  to explicitly  articulate  what it  means for  the
<em>Compute Phase</em>  to  succeed.  To do that,
<em>we  specify the opposite condition</em>, i.e. when  it fails.
In all other  scenarios the  phase is
considered successful.</p><p>The success status is important, because it
decides if the action phase has to be executed afterwards.</p><p>For the phase to fail, one of the following conditions must hold:</p><ol><li>The smart-contract data is not committed after the execution<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup></li><li>The new smart-contract data is ill-formed</li><li>The generated actions list is ill-formed</li></ol><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>The  compute  phase  may  be considered   successful  even   if  the   computation  thrown   an exception. This is quite unintuitive, yet very important fact.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compute-phase-exit-code">Compute Phase Exit Code<a href="#compute-phase-exit-code" class="hash-link" aria-label="Direct link to Compute Phase Exit Code" title="Direct link to Compute Phase Exit Code">​</a></h3><p>The exit code value shows  if the computation finished normally or
was aborted  due to some  exception.</p><p>In case of the former, the exit code should have values 0 or 1.</p><p>In  case of  the latter,  the exception  might be  of a  system or
custom  type.  If  the  exception  is a  system  one, i.e.   not
intentionally emitted by the code using a special TVM instruction,
the exit code contains one of the standard exit codes.</p><p>If the exception  is custom, then the exit code  should also equal
to 0  or 1, but there  is an extra <code>exit_arg</code>   field that provides
the user defined code.</p><p>For standard TVM exception codes, see <a href="https://github.com/tonlabs/ton-labs-types/blob/af1dc71a9a2b46cb0d55a0956e44726374ba7c0c/src/types.rs#L306" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="calculate-gas-fee-algorithm">Calculate Gas Fee Algorithm<a href="#calculate-gas-fee-algorithm" class="hash-link" aria-label="Direct link to Calculate Gas Fee Algorithm" title="Direct link to Calculate Gas Fee Algorithm">​</a></h3><p>The algorithm to calculate the amount of coins to be paid for the consumed gas.</p><p><strong><em>Input:</em></strong></p><ul><li><code>gas_prices</code> — a structure with actual gas prices, has type  <a href="#calculate-gas-fee-algorithm">GasLimitsPrice</a></li><li><code>gas_used</code> — amount of gas units consumed by the computation, has type Uint</li></ul><p><strong><em>Output:</em></strong> The amount of coins to be paid for the gas.</p><p><strong><em>Modifies:</em></strong> None.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calc_gas_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_prices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_used</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> gas_used </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> gas_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> gas_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_gas_limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   gas_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flat_gas_price </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_used </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> gas_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flag_gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       gas_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> gas_fee</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compute-new-state-algorithm">Compute New State Algorithm<a href="#compute-new-state-algorithm" class="hash-link" aria-label="Direct link to Compute New State Algorithm" title="Direct link to Compute New State Algorithm">​</a></h3><p>The algorithm <code>compute_new_state</code>  computes the actual account state
by given account record, the balance and the message. In particular,
this algorithm is used to initialize uninitialized accounts with
code and data borrowed from an external message with non-empty
<code>state_init</code> field.</p><p><em><em>Input</em>:</em></p><ul><li><code>account</code> — account structure, has type <a href="/arch/accounts">Account</a></li><li><code>acc_balace</code> — current account balance, has type Uint</li><li><code>in_msg</code> — message being executed, has type <a href="/arch/message">Message</a></li></ul><p><em><em>Output</em>:</em></p><ul><li>On success, returns <strong>None</strong>.</li><li>On failure, returns one of the <code>ComputeSkipReason</code> codes.</li></ul><p><em><em>Modifies</em>:</em></p><ul><li><code>account</code></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compute_new_state</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateNonexist</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BadState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateActive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateUninit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">try_activate_by_init_code_hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BadState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccStateFrozen</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">try_activate_by_init_code_hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BadState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ComputeSkipReason</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="activate-by-init-algorithm">Activate By Init Algorithm<a href="#activate-by-init-algorithm" class="hash-link" aria-label="Direct link to Activate By Init Algorithm" title="Direct link to Activate By Init Algorithm">​</a></h3><p>The algorithm <code>try_activate_by_init_code_hash</code>    does    the initialization or re-initialization of the account, with the given <code>state_init</code>.</p><p><strong><em>Input:</em></strong></p><ul><li><code>account</code> — account structure to be initialized</li><li><code>state_init</code> — state_init field from the inbound message</li></ul><p><strong><em>Output:</em></strong></p><p>On success, returns <strong>Ok</strong>
On failure, returns <strong>Err</strong></p><p><strong><em>Modifies:</em></strong></p><ul><li><code>account</code> — the field <code>storage.state</code> gets updated by the state_init on success</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">try_activate_by_init_code_hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> AccountState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountUninit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AccountState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token builtin">hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         AccountState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountFrozen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">init_code_hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_init_hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> state_init_hash </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token builtin">hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AccountState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">init_code_hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initial-gas-algorithm">Initial Gas Algorithm<a href="#initial-gas-algorithm" class="hash-link" aria-label="Direct link to Initial Gas Algorithm" title="Direct link to Initial Gas Algorithm">​</a></h3><p>The  algorithm  computes  TVM Gas-related  initial  values.  Those values  are  provided  to  the  virtual  machine  right  before  a smart-contract execution. If the execution takes more than allowed gas, it gets stopped.</p><p><strong><em>Input</em></strong></p><ul><li><code>acc_balance</code>: current account balance</li><li><code>msg_balance</code>: message balance</li><li><code>is_external</code>: is the message external</li><li><code>gas_info</code>: structure with limits and prices for the workchain</li></ul><p><strong><em>Output</em></strong></p><p>Returns the structure Gas() containing 4 values:</p><ul><li><code>gas_limit</code>: the maximum gas value available for any smart-contract of the workchain</li><li><code>gas_credit</code>: the amount of gas to be credited for the execution before the smart-contract accepts the message</li><li><code>gas_max</code>: the maximum allowed gas to be spent on the execution of the current smart-contract</li><li><code>gas_prices</code>: a structure with gas prices</li></ul><p><strong><em>Modifies</em></strong>: None</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init_gas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_external</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gas_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calc_gas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gas_credit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> is_external</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gas_credit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_credit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_max</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gas_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gas_credit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gas_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_max</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calc_gas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Gas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_credit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_max</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_real_gas_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="account-from-message-algorithm">Account From Message Algorithm<a href="#account-from-message-algorithm" class="hash-link" aria-label="Direct link to Account From Message Algorithm" title="Direct link to Account From Message Algorithm">​</a></h3><p>The algorithm creates new account  by using data from the internal
message. External messages are rejected. Creation of a new account
based  on   an  external   message  is  located   elsewhere.   See
<a href="#compute-new-state-algorithm">compute_new_state</a> algorithm.</p><p><strong><em>Input</em></strong></p><ul><li>msg: incoming message being processed, has type <a href="/arch/message">Message</a></li><li>msg_remaining_balance: the current amount of coins left on the message balance, has type <code>Uint</code></li></ul><p><strong><em>Output</em></strong></p><ul><li>Either returns a new <a href="/arch/accounts">Account</a> object, or None. Both results are considered successful.</li></ul><p><strong><em>Modifies</em></strong>: None</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">account_from_message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_remaining_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> IntMsgInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg_remaining_balance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> init </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">code </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token builtin">hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">active_by_init_code_hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uninit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_remaining_balance</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="action-phase">Action Phase<a href="#action-phase" class="hash-link" aria-label="Direct link to Action Phase" title="Direct link to Action Phase">​</a></h2><p>By given ordered action list, the Action phase executes each action item in  the list by  applying proper  action handler.</p><p><em><em>Input</em>:</em></p><ul><li><code>tr</code> — transaction being constructed, has type <a href="#transaction">Transaction</a></li><li><code>account</code> — account executing the message, has type <a href="/arch/accounts">Account</a></li><li><code>original_acc_balance</code> — account balance after storage and credit phase, has type <code>Uint</code></li><li><code>acc_balance</code> — the mutable copy of the original_acc_balance, has type <code>Uint</code></li><li><code>msg_remaining_balance</code> — message balance without debt value if any, has type <code>Uint</code></li><li><code>compute_phase_fees</code> — gas fees from the compute phase, has type <code>Uint</code></li><li><code>actions</code> — list of actions generated on the Compute Phase, has type list(<a href="#type-of-actions">OutAction</a>)</li><li><code>new_data</code> — the smart-contract data after the Compute Phase, some binary blob.</li></ul><p><em><em>Output</em>:</em></p><p>On success, returns <code>Ok(phase, messages)</code> such that:</p><ul><li><code>phase</code> denotes the <a href="#action-phase-descriptor">Action Phase Descriptor</a></li><li><code>messages</code> denotes a list of messages to be sent, has type list(<a href="/arch/message">Message</a>)</li></ul><p>On error, returns <em>Err(result_code)</em>, such that:</p><ul><li><code>result_code</code> describes a type of an error, see <a href="#action-result-codes">here</a>.</li></ul><p><em><em>Modifies</em>:</em></p><ul><li><code>tr</code></li><li><code>account</code></li><li><code>acc_balance</code></li><li><code>msg_remaining_balance</code></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MAX_ACTIONS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">255</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">action_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> original_acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      msg_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compute_phase_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> actions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       acc_copy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       acc_remaining_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       phase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TrActionPhase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       total_reserved_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># Serialization issues are put aside, it is too low-level for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># our purpose.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># Interesting to note, actions overload leads to OK, not Error?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">actions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> MAX_ACTIONS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">result_code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RESULT_CODE_TOO_MANY_ACTIONS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action_list_hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">hash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">actions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tot_actions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">actions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       account_deleted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       out_msgs_tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_copy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> action </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> actions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> action </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> OutAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SendMsg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> SENDMSG_ALL_BALANCE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   out_msgs_tmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outmsg_action_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              msg_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              compute_phase_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              total_reserved_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              account_deleted</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msgs_created </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   out_msgs_tmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> action </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> OutAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReserveCurrency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reserve_action_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               original_acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">spec_actions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   total_reserved_value </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reserved_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">result_code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic"># phase.no_funds = True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># process messages that have SENDMSG_ALL_BALANCE flag set last</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># skipping all other already processed messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       out_msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> out_msgs_tmp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> SENDMSG_ALL_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               out_msgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outmsg_action_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          msg_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          compute_phase_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          total_reserved_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          account_deleted</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msgs_created </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               out_msgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       acc_remaining_balance </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> total_reserved_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fee </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_action_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account_deleted</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status_change </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AccStatusChange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       acc_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_remaining_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_msgs</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-phase-success-condition">Action Phase Success Condition<a href="#action-phase-success-condition" class="hash-link" aria-label="Direct link to Action Phase Success Condition" title="Direct link to Action Phase Success Condition">​</a></h3><p>All actions formed at the Compute Phase  were successfully processed.
If an action had a special error-canceling flag set, such error will
not result in the whole phase failure. The action will be skipped in
this case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-phase-validity-condition">Action Phase Validity Condition<a href="#action-phase-validity-condition" class="hash-link" aria-label="Direct link to Action Phase Validity Condition" title="Direct link to Action Phase Validity Condition">​</a></h3><p>To specify the validity condition, we will define the opposite, i.e. when
the action phase is considered <code>invalid</code>.</p><ul><li>The number of actions in the action list is greater than <code>MAX_ACTIONS</code></li><li>Any <code>SendMsg</code>  action processing finished with an error</li><li>The unknown action type was found during the processing</li></ul><p>In all other cases, the action phase is considered <code>valid</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sendmsg-action-handler">SendMsg Action Handler<a href="#sendmsg-action-handler" class="hash-link" aria-label="Direct link to SendMsg Action Handler" title="Direct link to SendMsg Action Handler">​</a></h3><p>The <code>SendMsg</code>  action handler  is responsible for generating messages
to be sent.  It may fail due to several reasons. In this case, the
action phase get stopped,  unless the <code>SENDMSG_IGNORE_ERROR</code>  flag is
set.</p><p><em><em>Input</em>:</em></p><ul><li><code>phase</code> — actual <a href="#action-phase-descriptor">Action Phase Descriptor</a></li><li><code>mode</code> — flags for sending the message</li><li><code>msg</code> — message being sent, has type <a href="/arch/message">Message</a></li><li><code>acc_balance</code> — actual account balance, has type UInt</li><li><code>msg_balance</code> — the message balance after debt being deducted, has type Uint</li><li><code>compute_phase_fees</code> — gas fees from Compute Phase</li><li><code>config</code> — blockchain configuration, has type <a href="#blockchainconfig-parameters">BlockchainConfig</a></li><li><code>my_addr</code> — account <a href="/arch/accounts#account-address">address</a></li><li><code>reserved_value</code> — the value of coins reserved by the ReserveCoins actions</li><li><code>account_deleted</code> — the output value, set to True if account needs to be deleted</li></ul><p><em><em>Output</em>:</em></p><p>On success, returns Ok(value), such that:</p><ul><li><code>value</code> — the amount of coins to be deducted from the account balance</li></ul><p>On failure, returns Err(result_code), such that:</p><ul><li><code>result_code</code> — describes the error, see <a href="#action-result-codes">here</a></li></ul><p><em><em>Modifies</em>:</em></p><ul><li><code>phase</code></li><li><code>mode</code></li><li><code>msg</code></li><li><code>acc_balance</code></li><li><code>msg_balance</code></li><li><code>account_deleted</code></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MAX_MSG_BITS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">**</span><span class="token number" style="color:#36acaa">21</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2 Mb</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAX_MSG_CELLS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">**</span><span class="token number" style="color:#36acaa">13</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_fwd_prices</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> is_masterchain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_prices_mc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_prices_wc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">outmsg_action_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          compute_phase_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> my_addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reserved_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          account_deleted</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    invalid_flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SENDMSG_REMAINING_MSG_BALANCE </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> SENDMSG_ALL_BALANCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_not_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> SENDMSG_VALID_FLAGS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_has_invalid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> invalid_flags </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> invalid_flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode_delete_not_sab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_DELETE_IF_EMPTY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_ALL_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode_not_valid </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> mode_has_invalid </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> mode_delete_not_sab</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_UNSUPPORTED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    skip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_IGNORE_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> my_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fwd_prices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_fwd_prices</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_masterchain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compute_wd_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># The message should be either internal message or event.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># It is impossible to send external message from the smart-contract.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> IntMsgInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> ExtOutMsgInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> IntMsgInfo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># =====================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Internal message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># =====================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounced </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ihr_disabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ihr_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fwd_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compute_wd_fee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fwd_mine_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mine_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fwd_fee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        total_fwd_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_fee </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ihr_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fwd_remain_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_fee </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> fwd_mine_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_ALL_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> SENDMSG_PAY_FEE_SEPARATELY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_REMAINING_MSG_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Send all the remaining balance of the inbound message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result_value </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> msg_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_PAY_FEE_SEPARATELY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result_value </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> compute_phase_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result_value </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> compute_phase_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_PAY_FEE_SEPARATELY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result_value </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> total_fwd_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> total_fwd_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> total_fwd_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_remain_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># =====================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># =====================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fwd_mine_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_fwd_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        total_fwd_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_fwd_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute_fwd_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> acc_balance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> result_value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_NOT_ENOUGH_GRAMS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_DELETE_IF_EMPTY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> SENDMSG_ALL_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_balance </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> reserved_value </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        account_deleted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> total_fwd_fees </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fwd_fees </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> total_fed_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> fwd_mine_fee </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_action_fees </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> fwd_mine_fee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tot_msg_size</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tot_msg_size</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> MAX_MSG_BITS </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       phase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tot_msg_size</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cells</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> MAX_MSG_CELLS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_INVALID_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SENDMSG_ALL_BALANCE </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> SENDMSG_REMAINING_MSG_BALANCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result_value</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reservecurrency-action-handler">ReserveCurrency Action Handler<a href="#reservecurrency-action-handler" class="hash-link" aria-label="Direct link to ReserveCurrency Action Handler" title="Direct link to ReserveCurrency Action Handler">​</a></h3><p>ReserveCurrency action handler is responsible for managing the reserve coins.</p><p><strong><em>Input:</em></strong></p><ul><li><code>mode</code> — <a href="#action-reservecurrency">Reserve flags</a> for the reserve action, has type <code>Uint</code></li><li><code>val</code> — amount of coins to be reserved, has type <code>Uint</code></li><li><code>orig_acc_balance</code> — account balance after the deduction of the storage fee and the debt, if any, has type <code>Uint</code></li><li><code>acc_remaining_balance</code> — amount of coins left on the balance after the reserve, has type <code>Uint</code></li></ul><p><strong><em>Output:</em></strong></p><p>On success, returns<code>Ok(reserved)</code>  value, such that:</p><ul><li><code>reserved</code>  denotes the amount of coins being reserved for the account</li></ul><p>On failure, returns <em>Err(result_code)</em>, such that:</p><ul><li><code>result_code</code></li></ul><p><em><em>Modifies</em>:</em></p><ul><li><code>acc_remaining_balance</code> — remaining account balance after the reserve amount being withheld</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reserve_action_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> orig_acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> RESERVE_VALID_MODES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_UNKNOWN_OR_INVALID_ACTION</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> RESERVE_PLUS_ORIG</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> RESERVE_REVERSE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reserved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orig_acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> reserved </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_UNSUPPORTED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reserved </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reserved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reserved </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> orig_acc_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> RESERVE_REVERSE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_UNKNOWN_OR_INVALID_ACTION</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reserved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> RESERVE_IGNORE_ERROR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reserved </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reserved</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remaining </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_remaining_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> remaining </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> reserved</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RESULT_CODE_NOT_ENOUGH_GRAMS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remaining </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remaining</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_remaining_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remaining</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mode </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> RESERVE_ALL_BUT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reserved</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_remaining_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> acc_remaining_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reserved</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bounce-phase">Bounce Phase<a href="#bounce-phase" class="hash-link" aria-label="Direct link to Bounce Phase" title="Direct link to Bounce Phase">​</a></h2><p>If error happens on the previous phases, the bounce phase takes place.</p><p><em><em>Input</em>:</em></p><ul><li><code>remaining_msg_balance</code> — message balance after all previous phases executed, has type <code>Uint</code></li><li><code>acc_balance</code> — remaining account balance after all previous phases executed, has type <code>Uint</code></li><li><code>compute_phase_fees</code> — the fees of the compute phase, has type <code>Uint</code></li><li><code>msg</code> — message being processed, has type <a href="/arch/message">Message</a></li><li><code>tr</code> — transaction object, has type <a href="#transaction">Transaction</a></li></ul><p><em><em>Output</em>:</em></p><p>On success, returns <code>Ok(TrBouncePhase, bounce_message)</code>, such that:</p><ul><li><code>TrBouncePhase</code>  is a Bounce Phase Descriptor</li><li><code>bounce_message</code>  is a bounce message to be included into the out_msgs queue</li></ul><p>On error, returns /ExecutorError.TrExecutorError/</p><p><em><em>Modifies</em>:</em></p><ul><li><code>tr</code> — adds the bounce message delivery fee to the total</li></ul><p><em><em>NOTE</em>:</em></p><ul><li>Function <code>get_fwd_prices()</code>  was defined <a href="#sendmsg-action-handler">here</a>.</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bounce_phase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remaining_msg_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> acc_balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 compute_phase_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExecutorError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TrExecutorError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StorageUsedShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fwd_prices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_fwd_prices</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_masterchain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fwd_full_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Cell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fwd_mine_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_prices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mine_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fwd_full_fees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fwd_fees </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_full_fees </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> fwd_mine_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> remaining_msg_balance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> fwd_full_fees </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> compute_phase_fees</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrBouncePhase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">no_funds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    acc_balance </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> remaining_msg_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remaining_msg_balance </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> fwd_full_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remaining_msg_balance </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> compute_phase_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ihr_disabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounce </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bounced </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ihr_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fwd_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fwd_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> remaining_msg_balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bounce_msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">with_header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">has_capability</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GlobalCapabilities</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CapBounceMsgBody</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shrink_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.</span><span class="token number" style="color:#36acaa">.256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># leave only 256 bits of the original body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bounce_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_fees </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> fwd_mine_fees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrBouncePhase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fwd_mine_fees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fwd_fees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bounce_msg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="functional-properties">Functional Properties<a href="#functional-properties" class="hash-link" aria-label="Direct link to Functional Properties" title="Direct link to Functional Properties">​</a></h2><p>In this  section, we  define the  main risks  of malfunction  in the module, and define several higher-level properties that should hold for the module to mitigate those risks.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="risks">Risks<a href="#risks" class="hash-link" aria-label="Direct link to Risks" title="Direct link to Risks">​</a></h3><p>We define a risk as a hazard event causing a significant loss for the end user.
We distinguish the following types of risks.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="financial-risks">Financial Risks<a href="#financial-risks" class="hash-link" aria-label="Direct link to Financial Risks" title="Direct link to Financial Risks">​</a></h4><p>The Transaction Executor is the only place in the Node that is responsible for
changing  the   account  balance.  Hence,  any   errors  in  related
operations  lead to  tokens loss  for the  user.  We  identify the
following financial risks for the module:</p><ol><li>Incorrect storage, delivery or gas fees calculation logic</li><li>Incorrect message value processing logic</li><li>Incorrect <code>SendMsg</code>, <code>ReserveCoins</code>  actions processing logic</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="behavioral-risks">Behavioral Risks<a href="#behavioral-risks" class="hash-link" aria-label="Direct link to Behavioral Risks" title="Direct link to Behavioral Risks">​</a></h4><p>Everscale blockchain praises  the distributed programming paradigm
in  application development.  It means  that instead  of producing
huge smart-contract  monoliths, it is encouraged  to separate the
system into many manageable smart-contracts  that communicate with
each other by means of message passing.</p><p>The message passing scheme used in a system induces some protocol.
If message passing breaks in an unexpected way, the whole protocol
may stall, potentially  leading to global system  deadlocks.</p><p>It is of  utter importance to guarantee that  all produced correct
messages  will   be  eventually   delivered  to   the  destination
account. The delivery  process is complicated and  rely on several
node components. Here,  we identify risks related  to the Transaction Executor
part of it:</p><ul><li>Successful SendMsg action does not lead to creation of a corresponding
message</li><li>Generated messages do not occur in the Out Message queue</li><li>Message delivery order gets broken</li><li>A bounce message does not get generated as expected</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="assumptions">Assumptions<a href="#assumptions" class="hash-link" aria-label="Direct link to Assumptions" title="Direct link to Assumptions">​</a></h3><p>All the properties formulated with the following assumptions in mind:</p><ul><li>We consider only <code>ordinary</code>  accounts, not system (special) accounts.
For the latter, the properties might look different.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="system-properties">System Properties<a href="#system-properties" class="hash-link" aria-label="Direct link to System Properties" title="Direct link to System Properties">​</a></h3><p>System properties are high-level general statements on the system behavior
that the Transaction Executor should obey to. A subset of those statements related to
mitigating the main risks, identified in the previous section.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fees">Fees<a href="#fees" class="hash-link" aria-label="Direct link to Fees" title="Direct link to Fees">​</a></h4><ul><li><strong>FEE1</strong> — Gas fees for the computation equal the amount calculated using
the algorithm <a href="#calculate-gas-fee-algorithm">calc_gas_fee</a>.</li><li><strong>FEE2</strong> — Storage fees for an account equal the amount calculated using
the algorithm <a href="#data-storage-fee-calculation-algorithm">calc_storage_fee</a>.</li><li><strong>FEE3</strong> — Forwarding fees are calculated according to the algorithm <a href="#message-passing-fee">message_passing_fees</a> .</li><li><strong>FEE4</strong> — During the message execution process, all type of fees get deducted
only once for an account.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="message-processing">Message Processing<a href="#message-processing" class="hash-link" aria-label="Direct link to Message Processing" title="Direct link to Message Processing">​</a></h4><ul><li><strong>MSG1</strong> — The message coins get credited to the account balance before
executing a smart-contract logic.</li><li><strong>MSG2</strong> — Messages delivery order between the current account <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">a_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> and some other account <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">a_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>
does not depend on messages sent from <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">a_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> to some other account <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">a_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>, when <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>2</mn></msub><mo mathvariant="normal">≠</mo><msub><mi>a</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">a_2 \neq a_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="credit-phase-processing">Credit Phase Processing<a href="#credit-phase-processing" class="hash-link" aria-label="Direct link to Credit Phase Processing" title="Direct link to Credit Phase Processing">​</a></h4><ul><li><strong>CRD1</strong> — If the inbound message is external, the credit phase does not get executed.</li><li><strong>CRD2</strong> — If the inbound message is internal, the account&#x27;s balance get credited with the
message value minus the account debt, if any.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-phase-processing">Storage Phase Processing<a href="#storage-phase-processing" class="hash-link" aria-label="Direct link to Storage Phase Processing" title="Direct link to Storage Phase Processing">​</a></h4><ul><li><strong>STR1</strong> — If there is not enough funds to cover the storage phase fee on the account&#x27;s balance, and if the account is in the Active status, then the account gets a debt storing in the <code>due_payment</code> field of the account. If the debt value exceeds the <code>freeze_due_limit</code> value, the account is switched into a frozen status. If the debt exceeds the <code>delete_due_limit</code> value, the account gets deleted.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="compute-phase-processing">Compute Phase Processing<a href="#compute-phase-processing" class="hash-link" aria-label="Direct link to Compute Phase Processing" title="Direct link to Compute Phase Processing">​</a></h4><ul><li><strong>CMP1</strong> — If the <a href="#compute-phase-success-conditions">Compute Phase fails</a>, the execution of a message is aborted. The bounce message is not created in this case.</li><li><strong>CMP2</strong> — After the Compute Phase, the account&#x27;s balance gets decreased exactly on the amount of consumed gas.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="action-phase-processing">Action Phase Processing<a href="#action-phase-processing" class="hash-link" aria-label="Direct link to Action Phase Processing" title="Direct link to Action Phase Processing">​</a></h4><ul><li><strong>ACT1</strong> — Each successful <a href="#action-sendmsg">SendMsg</a> action leads to creation of a message.</li><li><strong>ACT2</strong> — Successfully created message is added into the out queue exactly once.</li><li><strong>ACT3</strong> — If the action phase fails and the incoming message has the bounce flag set, then a single bounce message is generated and put into the out queue.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bounce-phase-processing">Bounce Phase Processing<a href="#bounce-phase-processing" class="hash-link" aria-label="Direct link to Bounce Phase Processing" title="Direct link to Bounce Phase Processing">​</a></h4><ul><li><strong>BNC1</strong> — The bounce message is generated only if and only if all of the following conditions hold:</li></ul><p>1) The incoming message is an internal message
2) The incoming message has the bounce flag set
3) During the message processing, the action phase was executed, but failed
4) After the failed action phase, there is enough funds left on the incoming message balance to cover the bounce message processing<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>.</p><ul><li><strong>BNC2</strong> — A bounce message attach all the original message value minus the storage, gas and delivery fees.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="footnotes">Footnotes<a href="#footnotes" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2><div class="footnotes"><hr><ol><li id="fn-1">Well, at least, until the part of the chain residing the transaction gets cut-off to reduce the disk space consumption.<a href="#fnref-1" class="footnote-backref">↩</a></li><li id="fn-2">See the definition of COMMIT TVM instruction.<a href="#fnref-2" class="footnote-backref">↩</a></li></ol></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/everscale-org/docs/edit/main/.build/website/../../src/arch/35-executor.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-06-15T09:49:07.000Z">Jun 15, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/arch/managing-gas"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Gas Calculation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/arch/logic-time"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Logical Time</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#document-structure" class="table-of-contents__link toc-highlight">Document Structure</a></li><li><a href="#everscale-platform-architecture" class="table-of-contents__link toc-highlight">Everscale Platform Architecture</a></li><li><a href="#platform-implementation" class="table-of-contents__link toc-highlight">Platform Implementation</a></li><li><a href="#transaction-executor-module" class="table-of-contents__link toc-highlight">Transaction Executor Module</a><ul><li><a href="#remark" class="table-of-contents__link toc-highlight">Remark</a></li><li><a href="#inputs-and-outputs" class="table-of-contents__link toc-highlight">Inputs and Outputs</a></li><li><a href="#multichain-architecture" class="table-of-contents__link toc-highlight">Multichain Architecture</a></li><li><a href="#multicurrency-payments" class="table-of-contents__link toc-highlight">Multicurrency payments</a></li><li><a href="#hashing-algorithm" class="table-of-contents__link toc-highlight">Hashing Algorithm</a></li></ul></li><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters</a></li><li><a href="#transaction" class="table-of-contents__link toc-highlight">Transaction</a></li><li><a href="#transaction-executor-1" class="table-of-contents__link toc-highlight">Transaction Executor</a><ul><li><a href="#transaction-executor-types" class="table-of-contents__link toc-highlight">Transaction Executor Types</a></li><li><a href="#main-entry-point" class="table-of-contents__link toc-highlight">Main Entry Point</a></li><li><a href="#blockchainconfig-parameters" class="table-of-contents__link toc-highlight">BlockchainConfig parameters</a></li><li><a href="#code-execution-fee" class="table-of-contents__link toc-highlight">Code Execution Fee</a></li><li><a href="#message-passing-fee" class="table-of-contents__link toc-highlight">Message Passing Fee</a></li><li><a href="#data-storage-fee" class="table-of-contents__link toc-highlight">Data Storage Fee</a></li><li><a href="#special-smart-contracts" class="table-of-contents__link toc-highlight">Special Smart-Contracts</a></li><li><a href="#globalcapabilities-options" class="table-of-contents__link toc-highlight">GlobalCapabilities Options</a></li><li><a href="#rawconfig-options" class="table-of-contents__link toc-highlight">RawConfig options</a></li><li><a href="#error-code-enumeration" class="table-of-contents__link toc-highlight">Error Code Enumeration</a></li><li><a href="#error-code-enumeration-1" class="table-of-contents__link toc-highlight">Error Code Enumeration</a></li><li><a href="#account-state-update" class="table-of-contents__link toc-highlight">Account State Update</a></li><li><a href="#transaction-description-object" class="table-of-contents__link toc-highlight">Transaction Description Object</a></li></ul></li><li><a href="#actions" class="table-of-contents__link toc-highlight">Actions</a><ul><li><a href="#type-of-actions" class="table-of-contents__link toc-highlight">Type of Actions</a></li><li><a href="#action-sendmsg" class="table-of-contents__link toc-highlight">Action SendMsg</a></li><li><a href="#action-reservecurrency" class="table-of-contents__link toc-highlight">Action ReserveCurrency</a></li><li><a href="#action-setcode" class="table-of-contents__link toc-highlight">Action SetCode</a></li></ul></li><li><a href="#message-processing-algorithm" class="table-of-contents__link toc-highlight">Message Processing Algorithm</a></li><li><a href="#internal-message-processing-algorithm" class="table-of-contents__link toc-highlight">Internal Message Processing Algorithm</a></li><li><a href="#external-message-processing-algorithm" class="table-of-contents__link toc-highlight">External Message Processing Algorithm</a></li><li><a href="#credit-phase" class="table-of-contents__link toc-highlight">Credit Phase</a></li><li><a href="#storage-phase" class="table-of-contents__link toc-highlight">Storage Phase</a></li><li><a href="#compute-phase" class="table-of-contents__link toc-highlight">Compute Phase</a><ul><li><a href="#compute-phase-success-conditions" class="table-of-contents__link toc-highlight">Compute Phase Success Conditions</a></li><li><a href="#compute-phase-exit-code" class="table-of-contents__link toc-highlight">Compute Phase Exit Code</a></li><li><a href="#calculate-gas-fee-algorithm" class="table-of-contents__link toc-highlight">Calculate Gas Fee Algorithm</a></li><li><a href="#compute-new-state-algorithm" class="table-of-contents__link toc-highlight">Compute New State Algorithm</a></li><li><a href="#activate-by-init-algorithm" class="table-of-contents__link toc-highlight">Activate By Init Algorithm</a></li><li><a href="#initial-gas-algorithm" class="table-of-contents__link toc-highlight">Initial Gas Algorithm</a></li><li><a href="#account-from-message-algorithm" class="table-of-contents__link toc-highlight">Account From Message Algorithm</a></li></ul></li><li><a href="#action-phase" class="table-of-contents__link toc-highlight">Action Phase</a><ul><li><a href="#action-phase-success-condition" class="table-of-contents__link toc-highlight">Action Phase Success Condition</a></li><li><a href="#action-phase-validity-condition" class="table-of-contents__link toc-highlight">Action Phase Validity Condition</a></li><li><a href="#sendmsg-action-handler" class="table-of-contents__link toc-highlight">SendMsg Action Handler</a></li><li><a href="#reservecurrency-action-handler" class="table-of-contents__link toc-highlight">ReserveCurrency Action Handler</a></li></ul></li><li><a href="#bounce-phase" class="table-of-contents__link toc-highlight">Bounce Phase</a></li><li><a href="#functional-properties" class="table-of-contents__link toc-highlight">Functional Properties</a><ul><li><a href="#risks" class="table-of-contents__link toc-highlight">Risks</a></li><li><a href="#assumptions" class="table-of-contents__link toc-highlight">Assumptions</a></li><li><a href="#system-properties" class="table-of-contents__link toc-highlight">System Properties</a></li></ul></li><li><a href="#footnotes" class="table-of-contents__link toc-highlight">Footnotes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/everscale-org/job/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jobs and Vacancy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://everscale.network/files/Everscale_Whitepaper.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">White Paper<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://everscale.network/files/Everscale_Litepaper.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Lite Paper<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@everscale.network/search?query=Digest" target="_blank" rel="noopener noreferrer" class="footer__link-item">Digest<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://everscale.network/about/brand" target="_blank" rel="noopener noreferrer" class="footer__link-item">Visual Brand Identity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://everscale.network/grants" target="_blank" rel="noopener noreferrer" class="footer__link-item">Grants<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/everscale-org/bounties/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bounties<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/EverscaleSmartContracts" target="_blank" rel="noopener noreferrer" class="footer__link-item">Smart Contracts Chat<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/ever_validators" target="_blank" rel="noopener noreferrer" class="footer__link-item">Everscale Validators Channel<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/everscaledebots" target="_blank" rel="noopener noreferrer" class="footer__link-item">DeBots Chat<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/ever_sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">SDK Chat<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/everscale" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Workshop</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://everscale.guide/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Crash Course<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/develop/smart-contracts/">EverDev Tutorial</a></li><li class="footer__item"><a href="https://youtu.be/XKMnroPWXek" target="_blank" rel="noopener noreferrer" class="footer__link-item">Smart contract architecture<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://youtu.be/YBIaFeaksMY" target="_blank" rel="noopener noreferrer" class="footer__link-item">Smart contract development<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://youtu.be/vFAatJO6cBM" target="_blank" rel="noopener noreferrer" class="footer__link-item">Development of DeBots<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/tonlabs/samples" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sample smart-contracts<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/tonlabs/sdk-samples" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sample SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/tonlabs/TON-Solidity-Compiler/blob/master/API.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Solidity API<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/spec/abi/">ABI Specification</a></li><li class="footer__item"><a class="footer__link-item" href="/standard/TIP-4/">NFT</a></li><li class="footer__item"><a href="https://github.com/tonlabs/tonos-cli" target="_blank" rel="noopener noreferrer" class="footer__link-item">CLI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.everos.dev/ever-sdk/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2020—2023
 <a href="https://everscale.network/">Everscale</a> All rights reserved
  <a href="https://t.me/everscale">Touch</a>
 <br>
 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
    <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png">
 </a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.eded8d36.js"></script>
<script src="/assets/js/main.691c08bc.js"></script>
</body>
</html>